# Author: P3TERX (Modified and Optimized)
#=================================================
name: ðŸ’» X86_64
permissions:
  contents: write
  actions: read
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ðŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "ðŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ðŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ðŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ðŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ðŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ðŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ðŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      force_clean:
        description: "ðŸ§¹ å¼ºåˆ¶æ¸…ç†ç¼“å­˜"
        type: boolean
        default: false
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false
jobs:
  build:
    name: ðŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
    steps:
      # ============================================
      # 1. çŽ¯å¢ƒåˆå§‹åŒ–
      # ============================================
      - name: ðŸ”§ Setup Environment
        id: env
        run: |
          # æ—¶åŒºä¸Ž Git åŸºæœ¬é…ç½®
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æž„å»ºä¿¡æ¯
          VERSION=$(date +'%Y.%m.%d')
          DATE=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # è‡ªåŠ¨å¹¶è¡Œè®¡ç®—
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 2)) # ä¼˜åŒ–å†…å­˜è®¡ç®—
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date "+%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "FILE_DATE=$FILE_DATE" >> $GITHUB_ENV
          echo "COMPILE_JOBS=$JOBS" >> $GITHUB_ENV
          
      # ============================================
      # 2. ç³»ç»Ÿä¼˜åŒ–
      # ============================================
      - name: ðŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: ðŸ’¾ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "vm.swappiness = 10" | sudo tee -a /etc/sysctl.conf
          echo "vm.vfs_cache_pressure = 50" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p
          
      # ============================================
      # 3. ä»£ç æ£€å‡º
      # ============================================
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      # ============================================
      # 4. æž„å»ºä¾èµ–å®‰è£…
      # ============================================
      - name: ðŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ðŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      # ============================================
      # 5. æºç å‡†å¤‡ä¸Žä¿¡æ¯é‡‡é›†
      # ============================================
      - name: ðŸ“¥ Prepare OpenWrt Source
        run: |
          echo "ðŸ”„ Cloning OpenWrt source..."
          for attempt in 1 2 3; do
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "âŒ Attempt $attempt failed, retrying..."
            rm -rf openwrt
            sleep 15
          done
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          COMMIT_INFO=$(git log -1 --pretty=format:'%H|%an|%ai|%s')
          IFS='|' read -r COMMIT_HASH COMMIT_AUTHOR COMMIT_DATE COMMIT_MESSAGE <<< "$COMMIT_INFO"
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
      # ============================================
      # 6. ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
      # ============================================
      - name: â˜ï¸ Cache Toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.REPO_BRANCH }}-${{ github.run_number }}-v7
          restore-keys: |
            toolchain-${{ env.REPO_BRANCH }}-
     
      - name: â˜ï¸ Cache Builds and Downloads
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir/host*
            openwrt/build_dir/host*
            openwrt/.ccache
          key: cache-${{ env.REPO_BRANCH }}-${{ github.run_number }}-v7
          restore-keys: |
            cache-${{ env.REPO_BRANCH }}-
      # ============================================
      # 7. Feeds é…ç½®
      # ============================================
      - name: ðŸ“š Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          rm -rf feeds tmp/packagecache
          [ -f "${{ github.workspace }}/feeds.conf.default" ] && cp "${{ github.workspace }}/feeds.conf.default" .
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      # ============================================
      # 8. ccache é…ç½®
      # ============================================
      - name: ðŸ”§ Setup ccache
        run: |
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          mkdir -p "$CCACHE_DIR"
          ccache -M 15G
          ccache -s 
      # ============================================
      # 9. åº”ç”¨è‡ªå®šä¹‰é…ç½®
      # ============================================
      - name: ðŸŽ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky }}
          ENABLE_OAF: ${{ github.event.inputs.oaf }}
        run: |
          cd "$OPENWRT_PATH"
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          
          make defconfig
        
          echo "ðŸŽ¯ Target: $(awk -F'=' '/^CONFIG_TARGET_BOARD/ {print $2}' .config)"
          
      # ============================================
      # 10. å¼ºåˆ¶æ¸…ç†
      # ============================================
      - name: ðŸ§¹ Clean Build Directory
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          echo "ðŸ§¹ Force cleaning build directory..."
          make dirclean
      # ============================================
      # 11. ä¸‹è½½ä¾èµ–åŒ…
      # ============================================
      - name: ðŸ“¥ Download Packages
        run: |
          cd "$OPENWRT_PATH"
          echo "ðŸ“¥ Starting download process..."
          make download -j$(nproc)
      # ============================================
      # 12. ç¼–è¯‘å›ºä»¶
      # ============================================
      - name: ðŸ”¨ Compile Firmware
        id: compile
        run: |
          cd "$OPENWRT_PATH"
          echo "ðŸš€ Starting firmware compilation with $(nproc) cores..."
          make -j$(nproc)
      # ============================================
      # 13. æ•´ç†å›ºä»¶æ–‡ä»¶
      # ============================================
      - name: ðŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          echo "ðŸ“¦ Generated Files:"
          ls -lah
          
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          cp "$OPENWRT_PATH/.config" build.config
          
          echo "firmware_path=$PWD" >> $GITHUB_OUTPUT
          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
      # ============================================
      # 14. ä¸Šä¼  Artifacts
      # ============================================
      - name: ðŸ“¤ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ steps.organize.outputs.firmware_path }}
          retention-days: 30
          
      # ============================================
      # 15. åˆ›å»º Release
      # ============================================
      - name: ðŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ steps.organize.outputs.firmware_path }}/*
          body: |
            ## ðŸŽ¯ OpenWrt Firmware Release
            
            **LAN Address**: `${{ github.event.inputs.lan_addr }}`
            **Root Password**: `${{ github.event.inputs.root_password }}`
            **Kernel Version**: `${{ steps.organize.outputs.kernel_version }}`
