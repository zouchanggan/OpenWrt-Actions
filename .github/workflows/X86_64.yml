#=================================================
# ä¼˜åŒ–ç‰ˆï¼šç¼“å­˜å‘½ä¸­ç‡æå‡åˆ° 80%+
# Author: P3TERX (Modified and Optimized)
#=================================================
name: ğŸ’» X86_64

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.200"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      force_clean:
        description: "ğŸ§¹ å¼ºåˆ¶æ¸…ç†ç¼“å­˜"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
  # ğŸ”¥ æ–°å¢ï¼šå…¨å±€ ccache ç¯å¢ƒå˜é‡
  USE_CCACHE: 1
  CCACHE_COMPRESS: 1
  CCACHE_COMPRESSLEVEL: 6
  CCACHE_DIR: /home/runner/.ccache
  CCACHE_MAXSIZE: 20G

concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false

jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
    steps:
      # ============================================
      # 1. ç¯å¢ƒåˆå§‹åŒ–
      # ============================================
      - name: ğŸ”§ Setup Environment
        id: env
        run: |
          # æ—¶åŒºä¸ Git åŸºæœ¬é…ç½®
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ„å»ºä¿¡æ¯
          VERSION=$(date +'%Y.%m.%d')
          DATE=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # è‡ªåŠ¨å¹¶è¡Œè®¡ç®—
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 2))
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo "====================================="
          echo "ğŸ“Š System Information"
          echo "====================================="
          echo "CPU: $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)"
          echo "Cores: $PROC_COUNT | Memory: ${MEM_GB}GB | Jobs: $JOBS"
          echo "OS: $(lsb_release -ds) | Kernel: $(uname -r)"
          echo "Build: $VERSION ($BUILD_ID)"
          echo "====================================="
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          {
            echo "BUILD_VERSION=$VERSION"
            echo "BUILD_DATE=$DATE"
            echo "BUILD_ID=$BUILD_ID"
            echo "FILE_DATE=$FILE_DATE"
            echo "COMPILE_JOBS=$JOBS"
          } >> $GITHUB_ENV

      # ============================================
      # 2. ç³»ç»Ÿä¼˜åŒ–
      # ============================================
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: ğŸ’¾ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          EOF
          sudo sysctl -p
          echo "Memory status:"
          free -h

      # ============================================
      # 3. ä»£ç æ£€å‡º
      # ============================================
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ============================================
      # 4. æ„å»ºä¾èµ–å®‰è£…
      # ============================================
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm

      # ============================================
      # 5. ğŸ”¥ é¢„åˆ›å»ºç¼“å­˜ç›®å½•ï¼ˆæ–°å¢ï¼‰
      # ============================================
      - name: ğŸ—‚ï¸ Prepare Cache Directories
        run: |
          mkdir -p /home/runner/.ccache
          mkdir -p openwrt/{dl,staging_dir,build_dir}
          echo "CCACHE_DIR=/home/runner/.ccache" >> $GITHUB_ENV
          
          # å®‰è£…æœ€æ–° ccache
          sudo apt-get update && sudo apt-get install -y ccache

      # ============================================
      # 6. æºç å‡†å¤‡ä¸ä¿¡æ¯é‡‡é›†
      # ============================================
      - name: ğŸ“¥ Prepare OpenWrt Source
        run: |
          if ! git ls-remote --heads "$REPO_URL" "$REPO_BRANCH" &>/dev/null; then
            echo "âŒ Branch $REPO_BRANCH not found in $REPO_URL"
            git ls-remote --heads "$REPO_URL" | head -10
            exit 1
          fi
          
          echo "ğŸ”„ Cloning fresh OpenWrt source..."
          rm -rf openwrt
          
          for attempt in 1 2 3; do
            echo "ğŸ“¥ Clone attempt $attempt/3..."
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "âŒ Clone attempt $attempt failed"
            rm -rf openwrt
            if [ $attempt -lt 3 ]; then
              sleep 10
            else
              echo "âŒ All clone attempts failed"
              exit 1
            fi
          done
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # è·å–æäº¤ä¿¡æ¯
          if git log -1 --pretty=format:'%an|%ci|%s|%H' &>/dev/null; then
            COMMIT_INFO=$(git log -1 --pretty=format:'%an|%ci|%s|%H')
            IFS='|' read -r AUTHOR DATE MESSAGE HASH <<< "$COMMIT_INFO"
          else
            AUTHOR="Unknown"; DATE="Unknown"; MESSAGE="Unknown"; HASH="Unknown"
          fi
          
          {
            echo "COMMIT_AUTHOR=${AUTHOR}"
            echo "COMMIT_DATE=${DATE}"
            echo "COMMIT_MESSAGE=${MESSAGE}"
            echo "COMMIT_HASH=${HASH}"
          } >> $GITHUB_ENV

      # ============================================
      # 7. ğŸ”¥ ç”Ÿæˆç¨³å®šç¼“å­˜é”®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      # ============================================
      - name: ğŸ”‘ Generate Cache Keys
        id: cache-keys
        run: |
          # åŸºäºæºç çš„ç¨³å®šå“ˆå¸Œ
          SOURCE_HASH=$(echo "${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}" | sha256sum | cut -c1-8)
          
          # åŸºäºç¼–è¯‘é…ç½®çš„å“ˆå¸Œï¼ˆæ’é™¤æ—¶é—´ç›¸å…³ï¼‰
          CONFIG_HASH=$(echo "${{ github.event.inputs.docker }}-${{ github.event.inputs.ssrp }}-${{ github.event.inputs.passwall }}-${{ github.event.inputs.openclash }}-${{ github.event.inputs.nikki }}-${{ github.event.inputs.lucky }}-${{ github.event.inputs.oaf }}" | sha256sum | cut -c1-8)
          
          # æœˆåº¦é”®ï¼ˆé™ä½åˆ·æ–°é¢‘ç‡ï¼‰
          MONTH_KEY=$(date +'%Y%m')
          
          echo "source_hash=$SOURCE_HASH" >> $GITHUB_OUTPUT
          echo "config_hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "month_key=$MONTH_KEY" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Cache Keys:"
          echo "  Source: $SOURCE_HASH"
          echo "  Config: $CONFIG_HASH"
          echo "  Month: $MONTH_KEY"

      # ============================================
      # 8. ğŸ”¥ å¢å¼ºç‰ˆç¼“å­˜ç­–ç•¥ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
      # ============================================
      
      # ğŸ”¥ ccache ç‹¬ç«‹ç¼“å­˜ï¼ˆæœ€é‡è¦ï¼‰
      - name: â˜ï¸ Cache ccache (Primary)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: /home/runner/.ccache
          key: ccache-main-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.config_hash }}-${{ github.run_id }}
          restore-keys: |
            ccache-main-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.config_hash }}-
            ccache-main-${{ steps.cache-keys.outputs.source_hash }}-
            ccache-main-

      # å·¥å…·é“¾ç¼“å­˜ï¼ˆæœˆåº¦æ›´æ–°ï¼‰
      - name: â˜ï¸ Cache Toolchain
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.month_key }}-v8
          restore-keys: |
            toolchain-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.month_key }}-
            toolchain-${{ steps.cache-keys.outputs.source_hash }}-

      # Staging ç›®å½•ç¼“å­˜
      - name: â˜ï¸ Cache Staging Directory
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
          key: staging-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.month_key }}-v6
          restore-keys: |
            staging-${{ steps.cache-keys.outputs.source_hash }}-${{ steps.cache-keys.outputs.month_key }}-
            staging-${{ steps.cache-keys.outputs.source_hash }}-

      # ğŸ”¥ å¢å¼ºç‰ˆæ„å»ºç¼“å­˜ï¼ˆåŒ…å«æ›´å¤šè·¯å¾„ï¼‰
      - name: â˜ï¸ Cache Build Directory
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/host*
            openwrt/build_dir/target-*
            openwrt/.prepared
            openwrt/.configured
          key: build-${{ steps.cache-keys.outputs.config_hash }}-${{ github.run_id }}
          restore-keys: |
            build-${{ steps.cache-keys.outputs.config_hash }}-
            build-

      # ä¸‹è½½ç¼“å­˜
      - name: â˜ï¸ Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ steps.cache-keys.outputs.source_hash }}-v7
          restore-keys: |
            downloads-${{ steps.cache-keys.outputs.source_hash }}-
            downloads-

      # ============================================
      # 9. ğŸ”¥ å¢å¼ºç‰ˆ ccache é…ç½®ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
      # ============================================
      - name: ğŸ”¥ Configure ccache (Enhanced)
        run: |
          # ä½¿ç”¨å…¨å±€ ccache ç›®å½•
          export CCACHE_DIR=/home/runner/.ccache
          
          # ğŸ”¥ æ¿€è¿›ä¼˜åŒ–é…ç½®
          ccache --set-config=max_size=20G
          ccache --set-config=max_files=200000
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=sloppiness=file_macro,locale,time_macros,include_file_mtime,include_file_ctime,file_stat_matches,pch_defines
          ccache --set-config=hash_dir=false
          ccache --set-config=compiler_check=content
          ccache --set-config=depend_mode=true
          ccache --set-config=direct_mode=true
          ccache --set-config=recache=false
          
          # åˆ›å»ºç¼–è¯‘å™¨é“¾æ¥
          sudo ln -sf /usr/bin/ccache /usr/local/bin/gcc
          sudo ln -sf /usr/bin/ccache /usr/local/bin/g++
          sudo ln -sf /usr/bin/ccache /usr/local/bin/cc
          sudo ln -sf /usr/bin/ccache /usr/local/bin/c++
          
          # æ˜¾ç¤ºåˆå§‹çŠ¶æ€
          echo "=== ccache initial setup ==="
          ccache -s
          ccache -p | grep -E "max_size|max_files|sloppiness|compression"
          echo "============================"
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          {
            echo "PATH=/usr/lib/ccache:/usr/local/bin:$PATH"
            echo "CCACHE_DIR=/home/runner/.ccache"
            echo "USE_CCACHE=1"
            echo "CCACHE_COMPRESS=1"
            echo "CONFIG_CCACHE=y"
            echo "CONFIG_DEVEL=y"
          } >> $GITHUB_ENV

      # ============================================
      # 10. ç®€åŒ–çš„ Feeds é…ç½®
      # ============================================
      - name: ğŸ“š Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          
          # ç¡®ä¿ feeds ç›®å½•å¹²å‡€
          echo "ğŸ§¹ Cleaning feeds directory..."
          rm -rf feeds tmp/packagecache
          
          # å¤åˆ¶ feeds é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "ğŸ“„ Using custom feeds.conf.default"
          else
            echo "::warning::feeds.conf.default not found, using upstream defaults."
          fi
          
          # æ›´æ–°å’Œå®‰è£… feeds
          echo "ğŸ”„ Updating feeds..."
          ./scripts/feeds update -a
          echo "ğŸ“¦ Installing feeds..."
          ./scripts/feeds install -a

      # ============================================
      # 11. è‡ªå®šä¹‰é…ç½®åŠæ’ä»¶å¼€å…³
      # ============================================
      - name: ğŸ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            mv $GITHUB_WORKSPACE/files $OPENWRT_PATH/files
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          # ğŸ”¥ åœ¨ .config ä¸­å¯ç”¨ ccache
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
          if [ -d "${{ github.workspace }}/scripts" ]; then
            find "${{ github.workspace }}/scripts" -name "*.sh" -exec chmod +x {} \;
          fi
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          "${{ github.workspace }}/scripts/preset-mihimo-core.sh" "$CLASH_KERNEL"
          "${{ github.workspace }}/scripts/preset-adguard-core.sh" "$CLASH_KERNEL"
          
          # ç”Ÿæˆé…ç½®
          echo "âš™ï¸ Generating defconfig..."
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
          } >> $GITHUB_ENV
          
          # è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/openwrt/openwrt/releases/latest" | \
            grep -m1 '"tag_name"' | cut -d'"' -f4 | sed 's/^v//' || echo "unknown")
          echo "LATEST_RELEASE=$LATEST_RELEASE" >> $GITHUB_ENV
          echo "ğŸ“± Target: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "ğŸ“Œ Latest Release: $LATEST_RELEASE"
          
          # æ˜¾ç¤ºæ’ä»¶çŠ¶æ€
          echo "ğŸ“¦ Plugin Status:"
          echo "  Docker: $ENABLE_DOCKER"
          echo "  SSRP: $ENABLE_SSRP"
          echo "  Passwall: $ENABLE_PASSWALL"
          echo "  OpenClash: $ENABLE_OPENCLASH"
          echo "  Nikki: $ENABLE_NIKKI"
          echo "  Lucky: $ENABLE_LUCKY"
          echo "  OAF: $ENABLE_OAF"

      # ============================================
      # 12. å¼ºåˆ¶æ¸…ç†
      # ============================================
      - name: ğŸ§¹ Clean Build Directory
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ§¹ Force cleaning build directory..."
          
          # ä¿å­˜é…ç½®æ–‡ä»¶
          cp .config .config.backup
          
          # æ¸…ç†æ„å»ºç›®å½•å’Œ ccache
          make dirclean
          ccache -C
          
          # æ¢å¤é…ç½®æ–‡ä»¶å¹¶é‡æ–°ç”Ÿæˆ
          cp .config.backup .config
          rm .config.backup
          make defconfig

      # ============================================
      # 13. ğŸ”¥ ç¼“å­˜é¢„çƒ­ï¼ˆæ–°å¢ï¼‰
      # ============================================
      - name: ğŸ”¥ Warm Up Cache
        if: github.event.inputs.force_clean != 'true'
        run: |
          cd "$OPENWRT_PATH"
          
          # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦å·²ç¼“å­˜
          if [ ! -d "staging_dir/toolchain-"* ]; then
            echo "ğŸ”¥ Warming up toolchain cache..."
            make tools/compile -j$((COMPILE_JOBS)) USE_CCACHE=1 CONFIG_CCACHE=y || true
            make toolchain/compile -j$((COMPILE_JOBS)) USE_CCACHE=1 CONFIG_CCACHE=y || true
          else
            echo "âœ… Toolchain already cached"
          fi
          
          echo "=== Cache warm-up stats ==="
          ccache -s | grep -E "cache hit rate|files in cache" || true

      # ============================================
      # 14. ä¸‹è½½ä¾èµ–åŒ…
      # ============================================
      - name: ğŸ“¥ Download Packages
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ“¥ Starting optimized package download..."
          
          # æå‡ä¸‹è½½å¹¶è¡Œåº¦
          DOWNLOAD_JOBS=$((COMPILE_JOBS < 16 ? COMPILE_JOBS * 2 : 16))
          
          # ä½¿ç”¨ aria2 åŠ é€Ÿä¸‹è½½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if command -v aria2c >/dev/null 2>&1; then
            echo "ğŸš€ Using aria2 for faster downloads"
            make download -j"$DOWNLOAD_JOBS" DOWNLOAD_TOOL="aria2c -x 4 -s 4" 2>&1 | tee download.log
          else
            make download -j"$DOWNLOAD_JOBS" 2>&1 | tee download.log
          fi

      # ============================================
      # 15. ğŸ”¥ ä¼˜åŒ–ç¼–è¯‘è¿‡ç¨‹ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰
      # ============================================
      - name: ğŸ”¨ Compile Firmware (Optimized)
        id: compile
        timeout-minutes: 600
        run: |
          cd "$OPENWRT_PATH"
          
          # ğŸ”¥ å¼ºåˆ¶ä½¿ç”¨ ccache
          export USE_CCACHE=1
          export CCACHE_DIR=/home/runner/.ccache
          export PATH="/usr/lib/ccache:/usr/local/bin:$PATH"
          export CONFIG_CCACHE=y
          export CONFIG_DEVEL=y
          export FORCE_UNSAFE_CONFIGURE=1
          
          # æ˜¾ç¤ºç¼–è¯‘å‰çŠ¶æ€
          echo "=== Pre-compile ccache stats ==="
          ccache -z  # é‡ç½®ç»Ÿè®¡
          ccache -s
          echo "================================="
          
          compile_with_jobs() {
            local jobs=$1
            local log_file="compile_j${jobs}.log"
            echo "ğŸ”§ Compiling with $jobs jobs..."
            
            if timeout 500m make -j"$jobs" \
              USE_CCACHE=1 \
              CONFIG_CCACHE=y \
              CONFIG_DEVEL=y \
              2>&1 | tee "$log_file"; then
              echo "âœ… Compilation successful with $jobs jobs"
              return 0
            else
              echo "âŒ Compilation failed with $jobs jobs"
              return 1
            fi
          }
          
          # å°è¯•ç¼–è¯‘ï¼ˆé€æ­¥é™ä½å¹¶è¡Œåº¦ï¼‰
          if compile_with_jobs "$COMPILE_JOBS"; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$COMPILE_JOBS" -gt 2 ] && compile_with_jobs $((COMPILE_JOBS/2)); then
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$COMPILE_JOBS" -gt 1 ] && compile_with_jobs 1; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ All compilation attempts failed"
            echo "=== Build Error Analysis ==="
            if [ -f "compile_j1.log" ]; then
              echo "Last 100 lines of single-threaded build:"
              tail -n 100 compile_j1.log
            fi
            echo "=== Recent package logs ==="
            find logs -name "*.log" -mtime -1 -exec echo "=== {} ===" \; -exec tail -n 30 {} \; 2>/dev/null | head -500
            exit 1
          fi
          
          # ğŸ”¥ è¯¦ç»†çš„ç¼“å­˜ç»Ÿè®¡
          echo "=== Post-compile ccache stats ==="
          ccache -s
          echo ""
          echo "=== ccache hit rate analysis ==="
          ccache -s | grep -E "Hits|Misses|Hit rate" || true
          echo ""
          echo "=== Cache directory details ==="
          du -sh /home/runner/.ccache
          find /home/runner/.ccache -type f | wc -l
          echo "================================="

      # ============================================
      # 16. ğŸ“Š ç¼“å­˜ç»Ÿè®¡åˆ†æï¼ˆå¢å¼ºç‰ˆï¼‰
      # ============================================
      - name: ğŸ“Š Cache Statistics
        if: always()
        run: |
          cd "$OPENWRT_PATH"
          echo "=== Cache Effectiveness Report ==="
          echo "Date: $(date)"
          echo "Branch: ${{ env.REPO_BRANCH }}"
          echo "Config Hash: ${{ steps.cache-keys.outputs.config_hash }}"
          echo "Month Key: ${{ steps.cache-keys.outputs.month_key }}"
          echo ""
          
          echo "ğŸ“ Directory Sizes:"
          du -sh dl/ 2>/dev/null || echo "dl/: Not found"
          du -sh /home/runner/.ccache/ 2>/dev/null || echo ".ccache/: Not found"
          du -sh staging_dir/ 2>/dev/null || echo "staging_dir/: Not found"
          du -sh build_dir/toolchain-* 2>/dev/null || echo "toolchain build_dir/: Not found"
          du -sh build_dir/host* 2>/dev/null || echo "host build_dir/: Not found"
          echo ""
          
          echo "ğŸ¯ ccache Statistics:"
          if command -v ccache >/dev/null 2>&1; then
            export CCACHE_DIR=/home/runner/.ccache
            ccache -s
            echo ""
            echo "ğŸ“ˆ Cache Hit Rate:"
            ccache -s | grep -E "(cache hit|cache miss|files in cache|called for|Cacheable)" || echo "Stats not available"
          else
            echo "ccache not available"
          fi
          echo "================================="

      # ============================================
      # 17. ğŸ”¥ ç¼“å­˜æŒä¹…åŒ–æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
      # ============================================
      - name: ğŸ“Š Verify Cache Persistence
        if: always()
        run: |
          echo "=== Cache Persistence Check ==="
          echo "CCACHE_DIR: $CCACHE_DIR"
          
          if [ -d "/home/runner/.ccache" ]; then
            echo "âœ… ccache directory exists"
            echo "Size: $(du -sh /home/runner/.ccache | cut -f1)"
            echo "Files: $(find /home/runner/.ccache -type f | wc -l)"
            
            # æ£€æŸ¥ç¼“å­˜æœ‰æ•ˆæ€§
            ccache -s | grep -E "cache hit rate|direct hit rate|preprocessed hit rate" || true
          else
            echo "âŒ ccache directory not found"
          fi
          
          echo ""
          echo "=== Build Cache Status ==="
          for dir in dl staging_dir build_dir; do
            if [ -d "$OPENWRT_PATH/$dir" ]; then
              echo "âœ… $dir: $(du -sh $OPENWRT_PATH/$dir | cut -f1)"
            else
              echo "âŒ $dir: not found"
            fi
          done
          echo "================================="

      # ============================================
      # 18. æ•´ç†å›ºä»¶æ–‡ä»¶
      # ============================================
      - name: ğŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          echo "=== Generated Files ==="
          ls -lah
          
          # å®‰å…¨æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$OPENWRT_PATH/.config" build.config
          
          # æ‰“åŒ…å†…æ ¸æ¨¡å—
          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz packages/
            rm -rf packages
          fi
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -f feeds.buildinfo version.buildinfo *.manifest
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯
          cat > firmware_info.json <<EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "commit_hash": "$COMMIT_HASH",
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          
          # è¾“å‡ºç»“æœ
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
      # ============================================
      # 19. ä¸Šä¼  Artifacts
      # ============================================
      - name: ğŸ“¤ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
      # ============================================
      # 20. åˆ›å»º Release
      # ============================================
      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }} â€¢ ${{ env.LATEST_RELEASE }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware [${{ env.BUILD_ID }}]
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **ç‰ˆæœ¬** | `${{ env.LATEST_RELEASE }}` |
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **Password** | `${{ github.event.inputs.root_password }}` |
            
            ### ğŸ“¦ åŒ…å«çš„æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            
            ### ğŸ“ æºç ä¿¡æ¯
            - **ä»“åº“**: ${{ env.REPO_URL }}
            - **åˆ†æ”¯**: `${{ env.REPO_BRANCH }}`
            - **æäº¤**: `${{ env.COMMIT_HASH }}`
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æ¶ˆæ¯**: ${{ env.COMMIT_MESSAGE }}
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            
            #### UEFI å›ºä»¶ï¼ˆæ¨èï¼‰ï¼š
            ```bash
            gunzip openwrt-*-generic-ext4-combined-efi.img.gz
            dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
