# Author: P3TERX (Modified and Optimized)
#=================================================
name: ğŸ’» X86_64
# ============================================
# è§¦å‘æ¡ä»¶
# ============================================
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
# ============================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ============================================
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64.sh
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  USE_CACHE: true
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
# ============================================
# å¹¶å‘æ§åˆ¶
# ============================================
concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false
# ============================================
# ä¸»ä»»åŠ¡
# ============================================
jobs:
  initialize:
    name: ğŸ¯ Initialize Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      date: ${{ steps.version.outputs.date }}
      build_id: ${{ steps.version.outputs.build_id }}
    steps:
      - name: ğŸ“ Generate Build Info
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')
          DATE=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“… Build Version: $VERSION"
          echo "ğŸ• Build Date: $DATE"
          echo "ğŸ”– Build ID: $BUILD_ID"
  build:
    name: ğŸ—ï¸ Build OpenWrt
    needs: initialize
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      BUILD_VERSION: ${{ needs.initialize.outputs.version }}
      BUILD_DATE: ${{ needs.initialize.outputs.date }}
      BUILD_ID: ${{ needs.initialize.outputs.build_id }}
    steps:
      - name: ğŸ”§ Setup Environment
        id: env
        run: |
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "TAG_TIME=$(date +'%Y.%m.%d')" >> $GITHUB_ENV
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 2))
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          echo "PROC_COUNT=$PROC_COUNT" >> $GITHUB_ENV
          echo "MEM_GB=$MEM_GB" >> $GITHUB_ENV
          echo "COMPILE_JOBS=$JOBS" >> $GITHUB_ENV
      - name: ğŸ“Š System Information
        run: |
          cat << EOF
          =====================================
          ğŸ“Š System Information
          =====================================
          CPU Model: $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)
          CPU Cores: ${{ env.PROC_COUNT }}
          Memory: ${{ env.MEM_GB }}GB
          Compile Jobs: ${{ env.COMPILE_JOBS }}
          Kernel: $(uname -r)
          OS: $(lsb_release -ds)
          =====================================
          Disk Usage:
          $(df -h | grep -E '^/dev/')
          =====================================
          EOF
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
      - name: ğŸ’¾ Setup Swap
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          cat << EOF | sudo tee -a /etc/sysctl.conf
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          vm.max_map_count=262144
          EOF
          sudo sysctl -p
          echo "Memory status:"
          free -h
      - name: âœ… Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      - name: ğŸ“¥ Clone OpenWrt Source
        id: clone
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          COMMIT_INFO=$(git log -1 --pretty=format:'%an|%ci|%s|%H')
          IFS='|' read -r AUTHOR DATE MESSAGE HASH <<< "$COMMIT_INFO"
          echo "COMMIT_AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$MESSAGE" >> $GITHUB_ENV
          echo "COMMIT_HASH=$HASH" >> $GITHUB_ENV
      - name: ğŸ’¾ Cache Management
        id: cache
        if: env.USE_CACHE == 'true'
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: true
          toolchain: true
          skip: false
          clean: false
          prefix: ${{ env.OPENWRT_PATH }}
          mixkey: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-x86_64-generic
        # ç¼“å­˜ç¼–è¯‘å·¥å…·é“¾ä¸ ccacheï¼Œæ˜¾è‘—ç¼©çŸ­åç»­æ„å»ºæ—¶é—´ï¼ŒåŒæ—¶éœ€æ³¨æ„ç¼“å­˜å‘½ä¸­æ—¶çš„æ®‹ç•™äº§ç‰©
      - name: ğŸ§½ Reset Build Artifacts
        run: |
          cd $OPENWRT_PATH
          # ç¼“å­˜æ¢å¤åç§»é™¤æ—§çš„ build/tmp ç­‰ç›®å½•ï¼Œé¿å…äºŒæ¬¡æ„å»ºå‡ºç°æ®‹ç•™å¼•å‘çš„å·¥å…·é“¾å†²çª
          rm -rf ./tmp
          rm -rf ./build_dir
          mkdir -p ./build_dir
          make defconfig
        # è¿™ä¸€æ­¥ç¡®ä¿å³ä½¿ç¼“å­˜å‘½ä¸­ä¹Ÿèƒ½ä»å¹²å‡€çš„ç¼–è¯‘ç›®å½•å¼€å§‹
      - name: ğŸ“š Update Feeds
        run: |
          cd $OPENWRT_PATH
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp ${{ github.workspace }}/feeds.conf.default .
          else
            echo "::warning::feeds.conf.default not found in . Using default OpenWrt feeds."
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: ğŸ¨ Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            mv "$GITHUB_WORKSPACE/files" "$OPENWRT_PATH/files"
          fi
          if [ -d "$GITHUB_WORKSPACE/scripts" ]; then
            chmod +x "$GITHUB_WORKSPACE"/scripts/*.sh || true
          fi
          if [ -f "$DIY_SCRIPT" ]; then
            chmod +x "$DIY_SCRIPT"
          fi
          cd "$OPENWRT_PATH"
          cp "$GITHUB_WORKSPACE/${CONFIG_FILE}" .config
          "$GITHUB_WORKSPACE/$DIY_SCRIPT"
          "$GITHUB_WORKSPACE/scripts/preset-mihimo-core.sh" "$CLASH_KERNEL"
          "$GITHUB_WORKSPACE/scripts/preset-adguard-core.sh" "$CLASH_KERNEL"
          make defconfig
          DEVICE_TARGET=$(grep '^CONFIG_TARGET_BOARD=' .config | cut -d'"' -f2)
          DEVICE_SUBTARGET=$(grep '^CONFIG_TARGET_SUBTARGET=' .config | cut -d'"' -f2)
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          echo "IP_ADDR=${{ github.event.inputs.lan_addr }}" >> $GITHUB_ENV
          echo "ROOT_PASSWORD=${{ github.event.inputs.root_password }}" >> $GITHUB_ENV
          latest_release=$(curl -s "https://api.github.com/repos/openwrt/openwrt/releases/latest" | grep "tag_name" | head -n 1 | cut -d : -f2 | sed 's/[ \"v,]//g')
          echo "latest_release=${latest_release}" >> $GITHUB_ENV
          echo "ğŸ“± Target: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "ğŸ“Œ Latest Release: $latest_release"
      - name: ğŸ“¥ Download Packages
        run: |
          cd $OPENWRT_PATH
          echo "ğŸ“¥ Starting package download..."
          make download -j$((COMPILE_JOBS + 1))
          echo "ğŸ” Checking for failed downloads..."
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          make download -j1 || true
          echo "âœ… Download completed"
      - name: ğŸ”¨ Compile Firmware
        id: compile
        timeout-minutes: 600
        run: |
          cd $OPENWRT_PATH
          cat << EOF
          =====================================
          ğŸ”¨ Starting Compilation
          =====================================
          Jobs: $COMPILE_JOBS
          Flags: $BUILD_FLAGS
          Time: $(date)
          =====================================
          EOF
          compile_firmware() {
            local jobs=$1
            echo "ğŸ”§ Compiling with $jobs jobs..."
            if make -j"$jobs" $BUILD_FLAGS 2>&1 | tee compile.log; then
              return 0
            else
              return 1
            fi
          }
          if compile_firmware "$COMPILE_JOBS"; then
            echo "âœ… Compilation successful!"
          elif compile_firmware "$((COMPILE_JOBS/2))"; then
            echo "âœ… Compilation successful (reduced jobs)!"
          elif compile_firmware 1; then
            echo "âœ… Compilation successful (single job)!"
          else
            echo "âŒ Compilation failed!"
            echo "=== Last 100 lines of compile.log ==="
            tail -n 100 compile.log
            exit 1
          fi
          echo "status=success" >> $GITHUB_OUTPUT
        # æ ¹æ®ç¡¬ä»¶èµ„æºåŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦ï¼Œå¤±è´¥æ—¶é€æ­¥é™çº§ï¼Œæœ€å¤§é™åº¦ä¿è¯æ„å»ºæˆåŠŸç‡
      - name: ğŸ’¾ Check Space
        if: always()
        run: |
          echo "=== Disk Usage ==="
          df -h
          echo
          echo "=== Memory Usage ==="
          free -h
      - name: ğŸ“¦ Organize Firmware
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $OPENWRT_PATH/bin/targets/*/*
          echo "=== Generated files ==="
          ls -lah
          KERNEL_VERSION=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')
          cp $OPENWRT_PATH/.config build.config
          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz packages/
            rm -rf packages
          fi
          rm -f feeds.buildinfo version.buildinfo
          cat > firmware_info.json << EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "commit_hash": "$COMMIT_HASH",
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          echo "firmware_path=$PWD" >> $GITHUB_OUTPUT
          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        # å°†å…³é”®æ„å»ºä¿¡æ¯å›ºåŒ–ï¼Œä¾¿äºå‘å¸ƒ/æ’é”™
      - name: ğŸ“¤ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }}-OpenWrt-${{ env.FIRMWARE_TAG }}
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.BUILD_VERSION }}
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware [${{ env.BUILD_ID }}]
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **ç‰ˆæœ¬** | `${{ env.latest_release }}` |
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **æ¶æ„** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ env.KERNEL_VERSION }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **å¯†ç ** | `${{ github.event.inputs.root_password }}` |
            
            ### ğŸ“¦ åŒ…å«çš„æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            
            ### ğŸ“ æºç ä¿¡æ¯
            - **ä»“åº“**: [${{ env.REPO_URL }}](${{ env.REPO_URL }})
            - **åˆ†æ”¯**: `${{ env.REPO_BRANCH }}`
            - **æäº¤**: `${{ env.COMMIT_HASH }}`
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æ¶ˆæ¯**: ${{ env.COMMIT_MESSAGE }}
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            ```bash
            # è§£å‹å›ºä»¶
            gunzip openwrt-*.img.gz
            
            # å†™å…¥è®¾å¤‡
            dd if=openwrt-*.img of=/dev/sdX bs=4M status=progress
