name: ğŸ’» Build OpenWrt (x86_64)
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "è®¾ç½®é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "é»˜è®¤ root å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ passwordï¼‰"
        default: "password"
        required: false
        type: string
      docker:
        description: "ç¼–è¯‘ Docker"
        type: boolean
        default: true
      ssrp:
        description: "ç¼–è¯‘ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ç¼–è¯‘ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ç¼–è¯‘ Nikki"
        type: boolean
        default: true
      openclash:
        description: "ç¼–è¯‘ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ç¼–è¯‘ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ç¼–è¯‘ OpenAppFilter"
        type: boolean
        default: true
env:
  REPO_URL: openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CACHE_VER: v2 # å¦‚æœä½ æƒ³å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸ªå€¼
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64.sh
  CLASH_KERNEL: amd64
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: X86_64
jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360 # ç¼©çŸ­æ€»è¶…æ—¶ï¼Œ6å°æ—¶å¤ªé•¿äº†ï¼Œä¼˜åŒ–ååº”è¯¥åœ¨3å°æ—¶å†…
    steps:
      - name: Setup environment
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          # è®¾ç½® ccache é…ç½®ä»¥è·å¾—æ›´å¥½çš„ç¼“å­˜å‘½ä¸­ç‡
          echo "max_size = 5.0G" > $HOME/.ccache/ccache.conf
      - name: Free disk space
        uses: sbwml/actions@free-disk
      - name: Checkout Action main repository
        uses: actions/checkout@v4
        with:
          # åªæ£€å‡ºåŒ…å«é…ç½®æ–‡ä»¶å’Œè„šæœ¬çš„ä¸»ä»“åº“
          path: main-repo
      - name: Checkout OpenWrt source code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO_URL }}
          ref: ${{ env.REPO_BRANCH }}
          path: openwrt
          fetch-depth: 1 # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦
      - name: Set up build environment and variables
        id: setup
        run: |
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          # è·å–ä¸€æ¬¡ commit ä¿¡æ¯
          COMMIT_INFO=$(git show -s --format='
          COMMIT_AUTHOR: ä½œè€…: %an
          COMMIT_DATE: æ—¶é—´: %ci
          COMMIT_MESSAGE: å†…å®¹: %s
          COMMIT_HASH: hash: %H
          ')
          echo "$COMMIT_INFO" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(date +%s)" >> $GITHUB_ENV
          
          # ã€é‡è¦ä¿®æ­£ã€‘è·å–æœ€æ–°ç¨³å®šç‰ˆ Tag çš„æ­£ç¡®æ–¹æ³•
          # openwrt/openwrt æ²¡æœ‰ 'latest' releaseï¼Œéœ€è¦ä» tags è·å–
          latest_release=$(curl -s "https://api.github.com/repos/openwrt/openwrt/tags" | jq -r '.[].name' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1 | sed 's/^v//')
          if [ -z "$latest_release" ]; then
            echo "::warning::Failed to fetch latest tag, using fallback."
            latest_release="24.10.x" # æˆ–è€…ä¸€ä¸ªå·²çŸ¥çš„ç‰ˆæœ¬
          fi
          echo "latest_release=$latest_release" >> $GITHUB_ENV
          echo "Latest release tag determined: $latest_release"
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zlib1g-dev libssl-dev rsync
      - name: Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ runner.os }}-${{ env.CACHE_VER }}-${{ hashFiles('main-repo/configs/**') }}
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}-${{ hashFiles('openwrt/.config') }}
          max-size: 5G
      - name: Install Feeds
        run: |
          cd ${{ env.OPENWRT_PATH }}
          cp ${{ github.workspace }}/main-repo/feeds.conf.default .
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: Load Custom Configuration & DIY Script
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER:     ${{ github.event.inputs.docker }}
          ENABLE_SSRP:       ${{ github.event.inputs.ssrp }}
          ENABLE_PASSWALL:   ${{ github.event.inputs.passwall }}
          ENABLE_NIKKI:      ${{ github.event.inputs.nikki }}
          ENABLE_OPENCLASH:  ${{ github.event.inputs.openclash }}
          ENABLE_LUCKY:      ${{ github.event.inputs.lucky }}
          ENABLE_OAF:        ${{ github.event.inputs.oaf }}
        run: |
          cd ${{ env.OPENWRT_PATH }}
          # å¤åˆ¶åŸºç¡€é…ç½®æ–‡ä»¶
          cp ${{ github.workspace }}/main-repo/${{ env.CONFIG_FILE }} .config
          # æŒ‰éœ€è¿½åŠ é…ç½®
          # ... cat ... >> .config çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä½†è·¯å¾„è¦æ”¹ä¸º ${{ github.workspace }}/main-repo/...
          # æ‰§è¡Œ DIY è„šæœ¬
          chmod +x ${{ github.workspace }}/main-repo/${{ env.DIY_SCRIPT }}
          ${{ github.workspace }}/main-repo/${{ env.DIY_SCRIPT }}
          # ... æ‰§è¡Œå…¶ä»–è„šæœ¬ ...
          # ç”Ÿæˆæœ€ç»ˆ .config
          make defconfig
      - name: Download packages
        run: |
          cd ${{ env.OPENWRT_PATH }}
          make download -j$(nproc)
      - name: Compile Firmware
        id: compile
        run: |
          cd ${{ env.OPENWRT_PATH }}
          echo -e "Starting compile with $(nproc) threads"
          make -j$(nproc) || make -j1 V=s # V=s ä¼šåœ¨å¤±è´¥æ—¶æ‰“å°è¯¦ç»†æ—¥å¿—
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
          # ... å…¶ä»–è¾“å‡ºå˜é‡ ...
      # ... åç»­çš„æ•´ç†æ–‡ä»¶ã€ä¸Šä¼ ç­‰æ­¥éª¤ä¿æŒä¸å˜ ...
      # è®°å¾—å°†è·¯å¾„ä¸­çš„ $GITHUB_WORKSPACE æ›¿æ¢ä¸º ${{ github.workspace }}/main-repo
      # å°† $OPENWRT_PATH æ›¿æ¢ä¸º ${{ env.OPENWRT_PATH }}
      - name: Check space usage
        if: always()
        run: df -hT
      - name: Organise files
        if: steps.compile.outputs.status == 'success'
        run: |
          echo "::group::Organise files"
          cd $OPENWRT_PATH/bin/targets/*/*
          cat sha256sums
          cp $OPENWRT_PATH/.config build.config
          mkdir -p kernel
          mv -f packages/* kernel
          tar -zcf kernel.tar.gz kernel
          rm -rf packages feeds.buildinfo version.buildinfo kernel
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "::endgroup::"
      # å¯é€‰ä¸Šä¼  bin ç›®å½•
      - name: Upload Bin Directory (optional)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.OPENWRT_PATH }}/bin
      # ä¸Šä¼  firmware åˆ° Artifactï¼ˆä¸å‘å¸ƒåˆ° Release æ—¶ç”¨ï¼‰
      - name: Upload Firmware to Artifact (when not releasing)
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
      # ä¸Šä¼ åˆ°github Release
      - name: Upload Firmware to Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }}-${{ env.FIRMWARE_TAG }}-${{ env.latest_release }}
          tag: ${{ env.FIRMWARE_TAG }}-OpenWrt-${{ env.latest_release }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            **This is OpenWrt Firmware**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
            - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}
            - ğŸŒ é»˜è®¤åœ°å€: ${{ env.IP_ADDR }}
            - ğŸ”‘ é»˜è®¤å¯†ç : ${{ env.ROOT_PASSWORD }}
            ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
            - ç¼–è¯‘å‰æºç æœ€æ–°æäº¤
            - ${{ env.COMMIT_AUTHOR }}
            - ${{ env.COMMIT_DATE }}
            - ${{ env.COMMIT_MESSAGE }}
            - ${{ env.COMMIT_HASH }}
