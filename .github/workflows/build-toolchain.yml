name: ğŸ”§ Build Toolchain

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version'
        required: true
        default: 'openwrt-24.10'
        type: choice
        options:
          - openwrt-24.10      # æœ€æ–°ç¨³å®šç‰ˆ
          - openwrt-23.05
          - openwrt-22.03
          - master
      target:
        description: 'Target Platform (e.g., x86/64, ramips/mt7621)'
        required: true
        default: 'x86/64'
        type: string
      force_rebuild:
        description: 'Force rebuild even if toolchain exists'
        required: false
        default: false
        type: boolean
  
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥ 02:00 UTC
  
  repository_dispatch:
    types: [toolchain-rebuild]

env:
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'openwrt-24.10' }}
  TARGET_PLATFORM: ${{ github.event.inputs.target || 'x86/64' }}
  TZ: Asia/Shanghai

jobs:
  check-existing:
    name: ğŸ” Check Existing Toolchain
    runs-on: ubuntu-24.04
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      toolchain_hash: ${{ steps.check.outputs.toolchain_hash }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check Existing Toolchain
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ä¸ build-openwrt-4.yml ä¸€è‡´çš„å“ˆå¸Œç®—æ³•
          TOOLCHAIN_HASH=$(echo "${{ env.OPENWRT_VERSION }}-${{ env.TARGET_PLATFORM }}-$(uname -m)" | md5sum | cut -d' ' -f1 | cut -c1-40)
          
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Checking for Existing Toolchain"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Toolchain Information:"
          echo "  Version: ${{ env.OPENWRT_VERSION }}"
          echo "  Target: ${{ env.TARGET_PLATFORM }}"
          echo "  Host Arch: $(uname -m)"
          echo "  Hash: $TOOLCHAIN_HASH"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          RELEASE_TAG="toolchain-${TOOLCHAIN_HASH}"
          
          if gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            if [ "${{ github.event.inputs.force_rebuild }}" == "true" ]; then
              echo "ğŸ”„ Force rebuild requested"
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Toolchain already exists: $RELEASE_TAG"
              echo ""
              echo "ğŸ“¦ Existing files:"
              gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" --json assets --jq '.assets[].name'
              echo ""
              echo "â­ï¸  Skipping build"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ†• Toolchain not found, will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  build-toolchain:
    name: ğŸ”¨ Build Toolchain
    needs: check-existing
    if: needs.check-existing.outputs.should_build == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    
    steps:
      # ============================================
      # 1. æ£€å‡ºä»£ç 
      # ============================================
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. åˆå§‹åŒ–ç¯å¢ƒï¼ˆUbuntu 24.04 ä¼˜åŒ–ï¼‰
      # ============================================
      - name: ğŸ”§ Initialize Environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          
          # ç‰ˆæœ¬å’Œæ„å»ºä¿¡æ¯
          VERSION=$(date +'%Y.%m.%d')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          JOBS=$(nproc)
          
          # ğŸ”¥ åˆ›å»ºå®‰å…¨çš„æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
          TARGET_SAFE=$(echo "${{ env.TARGET_PLATFORM }}" | sed 's/[\/:]/-/g')
          
          {
            echo "BUILD_VERSION=$VERSION"
            echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')"
            echo "BUILD_ID=$BUILD_ID"
            echo "COMPILE_JOBS=$JOBS"
            echo "FILE_DATE=$(date +'%Y.%m.%d-%H%M')"
            echo "TARGET_SAFE=$TARGET_SAFE"
          } >> $GITHUB_ENV
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š System Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ–¥ï¸  OS: $(lsb_release -d | cut -f2)"
          echo "ğŸ”§ Kernel: $(uname -r)"
          echo "ğŸ’» CPU: $(nproc) cores ($(lscpu | grep 'Model name' | cut -d':' -f2 | xargs))"
          echo "ğŸ’¾ Memory: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "ğŸ’¿ Disk: $(df -h /workdir | awk 'NR==2 {print $4}') available"
          echo ""
          echo "ğŸ“‹ Build Configuration:"
          echo "  Version: $VERSION"
          echo "  Build ID: $BUILD_ID"
          echo "  Jobs: $JOBS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
        
      # ============================================
      # 3. å…‹éš† OpenWrt æºç 
      # ============================================
      - name: ğŸ“¦ Clone OpenWrt Source
        working-directory: /workdir
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Cloning OpenWrt ${{ env.OPENWRT_VERSION }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for attempt in 1 2 3; do
            echo "ğŸ“¥ Clone attempt $attempt/3..."
            if git clone --depth 1 --branch ${{ env.OPENWRT_VERSION }} \
              https://github.com/openwrt/openwrt.git openwrt; then
              break
            fi
            echo "âŒ Clone attempt $attempt failed"
            rm -rf openwrt
            if [ $attempt -lt 3 ]; then
              sleep 10
            else
              echo "âŒ All clone attempts failed"
              exit 1
            fi
          done
          
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          cd openwrt
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_HASH=$(git log -1 --format=%H)
          COMMIT_DATE=$(git log -1 --format=%ci)
          COMMIT_AUTHOR=$(git log -1 --format=%an)
          COMMIT_MESSAGE=$(git log -1 --format=%s)
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ OpenWrt Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Version: ${{ env.OPENWRT_VERSION }}"
          echo "Commit: ${COMMIT_HASH::7}"
          echo "Date: $COMMIT_DATE"
          echo "Author: $COMMIT_AUTHOR"
          echo "Message: $COMMIT_MESSAGE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          {
            echo "COMMIT_HASH=$COMMIT_HASH"
            echo "COMMIT_DATE=$COMMIT_DATE"
            echo "COMMIT_AUTHOR=$COMMIT_AUTHOR"
            echo "COMMIT_MESSAGE=$COMMIT_MESSAGE"
          } >> $GITHUB_ENV

      # ============================================
      # 4. æ›´æ–° Feeds
      # ============================================
      - name: ğŸ”„ Update Feeds
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ Updating Feeds"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ˜¾ç¤º feeds é…ç½®
          echo "ğŸ“‹ Feeds configuration:"
          cat feeds.conf.default
          echo ""
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo ""
          echo "âœ… Feeds updated successfully"

      # ============================================
      # 5. ç”Ÿæˆå·¥å…·é“¾é…ç½®
      # ============================================
      - name: âš™ï¸ Generate Toolchain Config
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Generating Toolchain Configuration"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è§£æç›®æ ‡å¹³å°
          TARGET=$(echo ${{ env.TARGET_PLATFORM }} | cut -d'/' -f1)
          SUBTARGET=$(echo ${{ env.TARGET_PLATFORM }} | cut -d'/' -f2)
          
          # è½¬æ¢ä¸ºå¤§å†™ï¼ˆç”¨äºé…ç½®ï¼‰
          TARGET_UPPER=$(echo $TARGET | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          SUBTARGET_UPPER=$(echo $SUBTARGET | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          
          echo "ğŸ“‹ Target Configuration:"
          echo "  Target: $TARGET ($TARGET_UPPER)"
          echo "  Subtarget: $SUBTARGET ($SUBTARGET_UPPER)"
          echo ""
          
          # ç”Ÿæˆæœ€å°é…ç½®ï¼ˆOpenWrt 24.10 ä¼˜åŒ–ï¼‰
          cat > .config <<EOF
          CONFIG_TARGET_${TARGET}=y
          CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
          
          # å·¥å…·é“¾é€‰é¡¹
          CONFIG_DEVEL=y
          CONFIG_TOOLCHAINOPTS=y
          CONFIG_CCACHE=y
          
          # ä½¿ç”¨ LLVM/Clangï¼ˆ24.10 æ–°ç‰¹æ€§ï¼‰
          CONFIG_USE_LLVM_BUILD=y
          CONFIG_USE_LLVM_HOST=y
          
          # ä¼˜åŒ–é€‰é¡¹
          CONFIG_TARGET_OPTIONS=y
          CONFIG_TARGET_OPTIMIZATION="-O2 -pipe -march=native"
          
          # ç¦ç”¨ä¸å¿…è¦çš„åŒ…
          # CONFIG_ALL_KMODS is not set
          # CONFIG_ALL_NONSHARED is not set
          EOF
          
          # å±•å¼€é…ç½®
          make defconfig
          
          echo ""
          echo "ğŸ“‹ Generated configuration:"
          grep "^CONFIG_TARGET" .config | head -10
          echo ""
          echo "âœ… Configuration generated"

      # ============================================
      # 6. ä¸‹è½½ä¾èµ–
      # ============================================
      - name: ğŸ“¥ Download Dependencies
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¥ Downloading Dependencies"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          make download -j$(nproc) V=s
          
          # æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶
          echo ""
          echo "ğŸ” Checking for failed downloads..."
          FAILED_COUNT=$(find dl -size 0 2>/dev/null | wc -l)
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "âš ï¸  Found $FAILED_COUNT failed downloads:"
            find dl -size 0 -exec ls -l {} \;
          else
            echo "âœ… All downloads successful"
          fi
          
          echo ""
          echo "ğŸ“Š Download statistics:"
          echo "  Total files: $(find dl -type f | wc -l)"
          echo "  Total size: $(du -sh dl | cut -f1)"
          echo ""
          echo "âœ… Dependencies downloaded"

      # ============================================
      # 7. ç¼–è¯‘å·¥å…·é“¾
      # ============================================
      - name: ğŸ”¨ Build Toolchain
        id: build_toolchain
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¨ Building Toolchain"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â° Start time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ–¥ï¸  CPU cores: $(nproc)"
          echo ""
          
          START_TIME=$(date +%s)
          
          # ç¼–è¯‘å·¥å…·é“¾
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”§ Phase 1: Building tools..."
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if ! make -j$(nproc) tools/install V=s; then
            echo "âŒ Tools build failed"
            exit 1
          fi
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”¨ Phase 2: Building toolchain..."
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if ! make -j$(nproc) toolchain/install V=s; then
            echo "âŒ Toolchain build failed"
            exit 1
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Toolchain Build Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â±ï¸  Duration: $((DURATION/3600))h $((DURATION%3600/60))m $((DURATION%60))s"
          echo "ğŸ• End time: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ccache ç»Ÿè®¡
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“Š ccache Statistics"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ccache -s 2>/dev/null || echo "ccache not available"

      # ============================================
      # 8. ğŸ”¥ éªŒè¯å·¥å…·é“¾ï¼ˆæ–°å¢ï¼‰
      # ============================================
      - name: ğŸ§ª Validate Toolchain
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª Validating Toolchain"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ Toolchain directory not found!"
            echo "Available directories:"
            ls -la staging_dir/
            exit 1
          fi
          
          echo "ğŸ“‚ Toolchain directory: $(basename "$TOOLCHAIN_DIR")"
          echo "TOOLCHAIN_NAME=$(basename "$TOOLCHAIN_DIR")" >> $GITHUB_ENV
          echo ""
          
          # æ£€æŸ¥ GCC
          GCC_BIN=$(find "$TOOLCHAIN_DIR/bin" -name "*-gcc" -type f | head -1)
          
          if [ -z "$GCC_BIN" ] || [ ! -f "$GCC_BIN" ]; then
            echo "âŒ GCC not found in $TOOLCHAIN_DIR/bin"
            echo "Available files:"
            ls -la "$TOOLCHAIN_DIR/bin/" | head -20
            exit 1
          fi
          
          echo "ğŸ“¦ Found GCC: $(basename "$GCC_BIN")"
          echo ""
          
          # ä¿®å¤æƒé™
          chmod +x "$GCC_BIN"
          
          # æµ‹è¯•ç¼–è¯‘å™¨
          echo "ğŸ§ª Testing compiler..."
          if ! "$GCC_BIN" --version; then
            echo "âŒ GCC test failed"
            exit 1
          fi
          
          GCC_VERSION=$("$GCC_BIN" --version | head -1)
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          
          echo ""
          
          # æ£€æŸ¥å¿…éœ€å·¥å…·
          echo "ğŸ” Checking required tools..."
          REQUIRED_TOOLS=(
            "*-g++"
            "*-ld"
            "*-ar"
            "*-as"
            "*-ranlib"
            "*-strip"
            "*-objcopy"
            "*-objdump"
          )
          
          MISSING_TOOLS=0
          for pattern in "${REQUIRED_TOOLS[@]}"; do
            TOOL=$(find "$TOOLCHAIN_DIR/bin" -name "$pattern" -type f | head -1)
            if [ -z "$TOOL" ]; then
              echo "âŒ Missing tool: $pattern"
              MISSING_TOOLS=$((MISSING_TOOLS + 1))
            else
              chmod +x "$TOOL" 2>/dev/null || true
              echo "âœ… Found: $(basename "$TOOL")"
            fi
          done
          
          if [ $MISSING_TOOLS -gt 0 ]; then
            echo ""
            echo "âŒ Toolchain incomplete: $MISSING_TOOLS missing tools"
            exit 1
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Toolchain Validation Passed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 9. ç”Ÿæˆå·¥å…·é“¾ä¿¡æ¯
      # ============================================
      - name: ğŸ“‹ Generate Toolchain Info
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Generating Toolchain Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è·å–ç¼–è¯‘å™¨ç‰ˆæœ¬
          TOOLCHAIN_PATH=$(find staging_dir -type d -name "toolchain-*" | head -1)
          
          if [ -d "$TOOLCHAIN_PATH" ]; then
            GCC_BIN=$(find "$TOOLCHAIN_PATH/bin" -name "*-gcc" -type f | head -1)
            LD_BIN=$(find "$TOOLCHAIN_PATH/bin" -name "*-ld" -type f | head -1)
            
            if [ -n "$GCC_BIN" ]; then
              GCC_VERSION=$("$GCC_BIN" --version 2>/dev/null | head -1 || echo "N/A")
            else
              GCC_VERSION="N/A"
            fi
            
            if [ -n "$LD_BIN" ]; then
              BINUTILS_VERSION=$("$LD_BIN" --version 2>/dev/null | head -1 || echo "N/A")
            else
              BINUTILS_VERSION="N/A"
            fi
            
            CLANG_VERSION=$(clang --version 2>/dev/null | head -1 || echo "N/A")
          else
            GCC_VERSION="N/A"
            BINUTILS_VERSION="N/A"
            CLANG_VERSION="N/A"
          fi
          
          # ç”Ÿæˆä¿¡æ¯æ–‡ä»¶
          cat > toolchain-info.txt <<EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Toolchain Information
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          OpenWrt Version: ${{ env.OPENWRT_VERSION }}
          Target Platform: ${{ env.TARGET_PLATFORM }}
          Build Date: ${{ env.BUILD_DATE }}
          Build Host: Ubuntu 24.04 LTS
          Build Kernel: $(uname -r)
          Toolchain Hash: ${{ needs.check-existing.outputs.toolchain_hash }}
          Toolchain Name: ${{ env.TOOLCHAIN_NAME }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Compiler Information
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          GCC Version:
          $GCC_VERSION
          
          Binutils Version:
          $BINUTILS_VERSION
          
          Clang Version:
          $CLANG_VERSION
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Source Information
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          Commit: ${{ env.COMMIT_HASH }}
          Author: ${{ env.COMMIT_AUTHOR }}
          Date: ${{ env.COMMIT_DATE }}
          Message: ${{ env.COMMIT_MESSAGE }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Directory Sizes
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          Staging Directory: $(du -sh staging_dir 2>/dev/null | cut -f1)
          Build Directory: $(du -sh build_dir 2>/dev/null | cut -f1)
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Build Features (OpenWrt 24.10)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          âœ… LLVM/Clang Support
          âœ… ccache Enabled
          âœ… Optimized Build Flags
          âœ… Multi-threaded Compilation
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          cat toolchain-info.txt
          echo ""
          echo "âœ… Toolchain information generated"

      # ============================================
      # 10. ğŸ”¥ æ‰“åŒ…å·¥å…·é“¾ï¼ˆå®Œå…¨ä¿®å¤ç‰ˆï¼‰
      # ============================================
      - name: ğŸ“¦ Package Toolchain
        working-directory: /workdir/openwrt
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Packaging Toolchain"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ğŸ”¥ å…³é”®ï¼šä½¿ç”¨ä¸ build-openwrt-4.yml ä¸€è‡´çš„æ–‡ä»¶å
          TOOLCHAIN_HASH="${{ needs.check-existing.outputs.toolchain_hash }}"
          PACKAGE_NAME="toolchain-${TOOLCHAIN_HASH}.tar.gz"
          
          echo "ğŸ“‹ Package Information:"
          echo "  Hash: $TOOLCHAIN_HASH"
          echo "  Name: $PACKAGE_NAME"
          echo ""
          
          # ğŸ”¥ å…³é”®ï¼šæ‰“åŒ…æ—¶ä¿æŒæ­£ç¡®çš„ç›®å½•ç»“æ„ï¼ˆä¸åŒ…å«é¡¶å±‚ç›®å½•ï¼‰
          echo "ğŸ—œï¸  Creating archive with correct structure..."
          echo "  This may take several minutes..."
          echo ""
          
          # ä½¿ç”¨ pigz è¿›è¡Œå¤šçº¿ç¨‹å‹ç¼©ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if command -v pigz &> /dev/null; then
            echo "âœ… Using pigz for faster compression"
            tar -I "pigz -9" -cf "/workdir/$PACKAGE_NAME" \
              staging_dir/ \
              build_dir/toolchain-* \
              toolchain-info.txt
          else
            echo "âœ… Using gzip for compression"
            tar -czf "/workdir/$PACKAGE_NAME" \
              staging_dir/ \
              build_dir/toolchain-* \
              toolchain-info.txt
          fi
          
          cd /workdir
          
          # ğŸ”¥ å…³é”®ï¼šéªŒè¯å‹ç¼©åŒ…ç»“æ„
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Verifying Archive Structure"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "First 20 entries in archive:"
          tar -tzf "$PACKAGE_NAME" 2>/dev/null | head -20
          echo ""
          
          # æ£€æŸ¥å…³é”®ç›®å½•
          VALIDATION_PASSED=true
          
          if tar -tzf "$PACKAGE_NAME" | grep -q "^staging_dir/toolchain-"; then
            echo "âœ… Found staging_dir/toolchain-*"
          else
            echo "âŒ ERROR: staging_dir/toolchain-* not found!"
            VALIDATION_PASSED=false
          fi
          
          if tar -tzf "$PACKAGE_NAME" | grep -q "^build_dir/toolchain-"; then
            echo "âœ… Found build_dir/toolchain-*"
          else
            echo "âš ï¸  WARNING: build_dir/toolchain-* not found (optional)"
          fi
          
          if tar -tzf "$PACKAGE_NAME" | grep -q "^toolchain-info.txt"; then
            echo "âœ… Found toolchain-info.txt"
          else
            echo "âš ï¸  WARNING: toolchain-info.txt not found"
          fi
          
          if [ "$VALIDATION_PASSED" = false ]; then
            echo ""
            echo "âŒ Archive structure validation failed!"
            echo "Full archive contents:"
            tar -tzf "$PACKAGE_NAME" | head -50
            exit 1
          fi
          
          echo ""
          echo "âœ… Archive structure validated"
          
          # è®¡ç®—æ ¡éªŒå’Œ
          echo ""
          echo "ğŸ” Calculating checksums..."
          SHA256=$(sha256sum "$PACKAGE_NAME" | awk '{print $1}')
          MD5=$(md5sum "$PACKAGE_NAME" | awk '{print $1}')
          
          # æ˜¾ç¤ºä¿¡æ¯
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Package Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          ls -lh "$PACKAGE_NAME"
          echo ""
          echo "ğŸ“¦ Package name: $PACKAGE_NAME"
          echo "ğŸ“ Package size: $(du -sh "$PACKAGE_NAME" | cut -f1)"
          echo "ğŸ” SHA256: $SHA256"
          echo "ğŸ” MD5: $MD5"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # ä¿å­˜ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡
          {
            echo "PACKAGE_NAME=$PACKAGE_NAME"
            echo "SHA256=$SHA256"
            echo "MD5=$MD5"
          } >> $GITHUB_ENV

      # ============================================
      # 11. ä¸Šä¼  Artifact
      # ============================================
      - name: ğŸ“¦ Upload Toolchain Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-${{ env.OPENWRT_VERSION }}-${{ env.TARGET_SAFE }}
          path: /workdir/${{ env.PACKAGE_NAME }}
          retention-days: 7
          compression-level: 0

      # ============================================
      # 12. åˆ›å»º Release
      # ============================================
      - name: ğŸš€ Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: toolchain-${{ needs.check-existing.outputs.toolchain_hash }}
          name: ğŸ”§ Toolchain - ${{ env.OPENWRT_VERSION }} (${{ env.TARGET_SAFE }})
          files: /workdir/${{ env.PACKAGE_NAME }}
          body: |
            ## ğŸ”§ é¢„ç¼–è¯‘å·¥å…·é“¾
            
            ### ğŸ“‹ åŸºæœ¬ä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **OpenWrt ç‰ˆæœ¬** | `${{ env.OPENWRT_VERSION }}` â­ |
            | **ç›®æ ‡å¹³å°** | `${{ env.TARGET_PLATFORM }}` |
            | **æ„å»ºç¯å¢ƒ** | Ubuntu 24.04 LTS |
            | **æ„å»ºæ—¶é—´** | `${{ env.BUILD_DATE }}` |
            | **å·¥å…·é“¾å“ˆå¸Œ** | `${{ needs.check-existing.outputs.toolchain_hash }}` |
            | **å·¥å…·é“¾åç§°** | `${{ env.TOOLCHAIN_NAME }}` |
            
            ### ğŸ”§ ç¼–è¯‘å™¨ä¿¡æ¯
            | ç»„ä»¶ | ç‰ˆæœ¬ |
            |------|------|
            | **GCC** | `${{ env.GCC_VERSION }}` |
            | **Clang** | âœ… å·²å¯ç”¨ (OpenWrt 24.10) |
            | **ccache** | âœ… å·²å¯ç”¨ |
            
            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.PACKAGE_NAME }}`
            - **å¤§å°**: çº¦ 1-2 GBï¼ˆå‹ç¼©åï¼‰
            - **SHA256**: `${{ env.SHA256 }}`
            - **MD5**: `${{ env.MD5 }}`
            
            ### âœ¨ æ–°ç‰¹æ€§ (OpenWrt 24.10)
            - âœ… **LLVM/Clang ç¼–è¯‘å™¨æ”¯æŒ**
            - âœ… **ä¼˜åŒ–çš„æ„å»ºæ ‡å¿—**
            - âœ… **æ”¹è¿›çš„ ccache é›†æˆ**
            - âœ… **æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦**
            - âœ… **å®Œæ•´çš„å·¥å…·é“¾éªŒè¯**
            
            ### ğŸ“ æºç ä¿¡æ¯
            - **ä»“åº“**: https://github.com/openwrt/openwrt
            - **åˆ†æ”¯**: `${{ env.OPENWRT_VERSION }}`
            - **æäº¤**: `${{ env.COMMIT_HASH }}`
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æ¶ˆæ¯**: ${{ env.COMMIT_MESSAGE }}
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            
            #### æ–¹æ³• 1ï¼šåœ¨ build-openwrt-4.yml ä¸­è‡ªåŠ¨ä½¿ç”¨
            ```yaml
            - name: ğŸ“¥ Download Prebuilt Toolchain
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                TOOLCHAIN_HASH="${{ needs.check-existing.outputs.toolchain_hash }}"
                gh release download "toolchain-$TOOLCHAIN_HASH" \
                  --repo "${{ github.repository }}" \
                  --pattern "toolchain-*.tar.gz" \
                  --dir /tmp/toolchain
