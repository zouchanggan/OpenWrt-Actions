# .github/workflows/Mediatek_mt7986.yml
# -------------------------------------------------
# Mediatek mt7986 ç¼–è¯‘å·¥ä½œæµï¼ˆå·²ä¿®æ­£ REPO_URLã€DIY_SCRIPTã€å˜é‡å¯¼å‡ºç­‰ï¼‰
# -------------------------------------------------
name: ğŸ›œ Mediatek_mt7986
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "Setting default LAN address"
        required: true
        default: "192.168.1.10"
        type: string
      root_password:
        description: "é»˜è®¤ root å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ passwordï¼‰"
        required: false
        default: "password"
        type: string
      docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker"
        type: boolean
        default: true
env:
  # ----------------------- åŸºç¡€ä¿¡æ¯ -----------------------
  REPO_URL: padavanonly/immortalwrt-mt798x-6.6   # **åªä¿ç•™ owner/repo**ï¼ˆä¸å¸¦ httpsï¼‰
  REPO_BRANCH: openwrt-24.10-6.6
  CONFIG_FILE: configs/mediatek_mt7986.config
  DIY_SCRIPT: scripts/diy-mediatek.sh
  CACHE_VER: v1
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: Mediatek_mt7986
  # ----------------------- é•œåƒ & Git åœ°å€ --------------------
  MIRROR: https://mirrors.tuna.tsinghua.edu.cn/openwrt
  GITEA: git.kejizero.online/zhao
  GITHUB: github.com
jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 420   # 7â€¯h
    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ åŸºç¡€ç¯å¢ƒ
      # -------------------------------------------------
      - name: Setup environment
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          git config --global user.name actions
          git config --global user.email action@github.com
      - name: Free disk space
        uses: sbwml/actions@free-disk
      # -------------------------------------------------
      # 2ï¸âƒ£ æ£€å‡ºæºç ï¼ˆç›´æ¥ä½¿ç”¨ actions/checkoutï¼‰
      # -------------------------------------------------
      - name: Checkout OpenWrt source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO_URL }}
          ref: ${{ env.REPO_BRANCH }}
          path: openwrt
          fetch-depth: 1   # åªè¦æœ€æ–°æäº¤
      # -------------------------------------------------
      # 3ï¸âƒ£ æ”¶é›†æºç å…ƒä¿¡æ¯ï¼ˆæäº¤ã€æ—¥æœŸç­‰ï¼‰
      # -------------------------------------------------
      - name: Export repository meta
        id: meta
        run: |
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git show -s --format='ä½œè€…: %an')"   >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git show -s --format='æ—¶é—´: %ci')"    >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git show -s --format='å†…å®¹: %s')" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git rev-parse HEAD)"                >> $GITHUB_ENV
          echo "SOURCE_REPO=$(basename ${{ env.REPO_URL }})"       >> $GITHUB_ENV
      # -------------------------------------------------
      # 4ï¸âƒ£ ç¼“å­˜ï¼šä¸‹è½½ã€å·¥å…·é“¾ã€feeds
      # -------------------------------------------------
      - name: Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            dl-${{ runner.os }}-${{ env.CACHE_VER }}-
            dl-${{ runner.os }}-
      - name: Cache Toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host
            openwrt/staging_dir/toolchain-*
          key: toolchain-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            toolchain-${{ runner.os }}-${{ env.CACHE_VER }}-
            toolchain-${{ runner.os }}-
      - name: Cache Feeds
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: feeds-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            feeds-${{ runner.os }}-${{ env.CACHE_VER }}-
            feeds-${{ runner.os }}-
      # -------------------------------------------------
      # 5ï¸âƒ£ ccache
      # -------------------------------------------------
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ env.CACHE_VER }}
          max-size: 10G
          compress: true
      # -------------------------------------------------
      # 6ï¸âƒ£ å®‰è£… LLVMï¼ˆé”å®š v14ï¼Œå…¼å®¹ OpenWrt 24.10ï¼‰
      # -------------------------------------------------
      - name: Install LLVM (v14)
        uses: sbwml/actions@install-llvm
        with:
          version: 14
      # -------------------------------------------------
      # 7ï¸âƒ£ å®‰è£… feedsï¼ˆä½¿ç”¨è‡ªå®šä¹‰ feeds.conf.defaultï¼‰
      # -------------------------------------------------
      - name: Install Feeds
        run: |
          cd $OPENWRT_PATH
          # åªä¿ç•™æˆ‘ä»¬éœ€è¦çš„ feedï¼Œé¿å…åé¢ rm -rf
          curl -fsSL -o feeds.conf.default \
            https://raw.githubusercontent.com/grandway2025/Actions-OpenWrt/main/Customize/feeds/feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      # -------------------------------------------------
      # 8ï¸âƒ£ åŠ è½½è‡ªå®šä¹‰ .config + è¿è¡Œ diy è„šæœ¬
      # -------------------------------------------------
      - name: Load Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
        run: |
          echo "::group::Load custom configuration"
          cd $OPENWRT_PATH
          # æŠŠæ ¹ç›®å½•çš„ filesï¼ˆå¦‚æœæœ‰ï¼‰æ¬è¿›æºç æ ‘
          [[ -e ../files ]] && mv ../files ./files
          # å¤åˆ¶åŸºå‡† .config
          cp ../${CONFIG_FILE} .config
          chmod +x $GITHUB_WORKSPACE/scripts/*.sh
          chmod +x $GITHUB_WORKSPACE/${DIY_SCRIPT}
          # è¿è¡Œ diy è„šæœ¬ï¼ˆå†…éƒ¨å·²å¤„ç†æ‰€æœ‰å¯é€‰æ’ä»¶ï¼‰
          $GITHUB_WORKSPACE/${DIY_SCRIPT}
          # å¦‚æœä½ è¿˜æœ‰ presetâ€‘* è„šæœ¬ï¼Œä¿ç•™ä¸‹é¢ä¸¤è¡Œï¼›å¦åˆ™å¯åˆ æ‰
          $GITHUB_WORKSPACE/scripts/preset-mihimo-core.sh $CLASH_KERNEL
          $GITHUB_WORKSPACE/scripts/preset-adguard-core.sh $CLASH_KERNEL
          # æœ€åä¸€æ¬¡ make defconfigï¼Œä¿è¯ .config å®Œæ•´ 
          make defconfig
          echo "::endgroup::"
          # å¯¼å‡ºåç»­éœ€è¦çš„å˜é‡ï¼ˆå³ä½¿ diy è„šæœ¬å·²ç»å†™å…¥ï¼Œè¿™é‡Œå†è¡¥ä¸€æ¬¡é˜²æ­¢é—æ¼ï¼‰
          DEVICE_TARGET=$(grep ^CONFIG_TARGET_BOARD .config | cut -d'"' -f2)
          DEVICE_SUBTARGET=$(grep ^CONFIG_TARGET_SUBTARGET .config | cut -d'"' -f2)
          echo "DEVICE_TARGET=$DEVICE_TARGET"   >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          echo "IP_ADDR=${{ github.event.inputs.lan_addr }}" >> $GITHUB_ENV
          echo "ROOT_PASSWORD=${{ github.event.inputs.root_password }}" >> $GITHUB_ENV
          # ä¸º Release ç”Ÿæˆå”¯ä¸€ Tagï¼ˆåŠ å…¥å®˜æ–¹ OpenWrt æœ€æ–° Releaseï¼‰
          latest_release=$(curl -fsSL "https://api.github.com/repos/${SOURCE_REPO}/releases/latest" \
            | jq -r .tag_name | sed 's/^v//')
          echo "latest_release=$latest_release" >> $GITHUB_ENV
      # -------------------------------------------------
      # 9ï¸âƒ£ åˆ†é˜¶æ®µæ„å»ºï¼ˆtools â†’ toolchain â†’ firmwareï¼‰
      # -------------------------------------------------
      - name: Build tools
        timeout-minutes: 120
        run: |
          echo "::group::Build tools"
          cd $OPENWRT_PATH
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          echo "::endgroup::"
      - name: Build toolchain
        timeout-minutes: 150
        run: |
          echo "::group::Build toolchain"
          cd $OPENWRT_PATH
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
          echo "::endgroup::"
      - name: Compile Firmware
        id: compile
        timeout-minutes: 180
        run: |
          echo "::group::Compile firmware"
          cd $OPENWRT_PATH
          export PATH="/usr/lib/ccache:$PATH"
          ccache -s
          make -j$(nproc) || make -j1 V=s
          ccache -s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
          echo "::endgroup::"
      # -------------------------------------------------
      # 10ï¸âƒ£ æ£€æŸ¥ç£ç›˜ & æ‰“åŒ…äº§ç‰©
      # -------------------------------------------------
      - name: Check space usage
        if: always()
        run: df -hT
      - name: Organise files
        if: steps.compile.outputs.status == 'success'
        run: |
          echo "::group::Organise files"
          cd $OPENWRT_PATH/bin/targets/*/*
          cat sha256sums
          cp $OPENWRT_PATH/.config build.config
          mkdir -p kernel
          mv -f packages/* kernel
          tar -Jcf kernel.tar.xz kernel   # å¤šçº¿ç¨‹ xzï¼Œä½“ç§¯æ›´å°
          rm -rf packages feeds.buildinfo version.buildinfo kernel
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "::endgroup::"
      # -------------------------------------------------
      # 11ï¸âƒ£ ä¸Šä¼ åˆ¶å“ï¼ˆå¯é€‰ Bin ç›®å½•ã€å›ºä»¶ï¼‰
      # -------------------------------------------------
      - name: Upload Bin Directory (optional)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.OPENWRT_PATH }}/bin
      - name: Upload Firmware to Artifact (when not releasing)
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
      # -------------------------------------------------
      # 12ï¸âƒ£ å‘å¸ƒ Releaseï¼ˆå¸¦å”¯ä¸€ tagï¼‰
      # -------------------------------------------------
      - name: Upload Firmware to Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }}-${{ env.FIRMWARE_TAG }}-${{ env.latest_release }}
          tag: ${{ env.FIRMWARE_TAG }}-OpenWrt-${{ env.latest_release }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            **OpenWrt Mediatek mt7986 Firmware**
            - **å¹³å°**: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - **æºç  ${{ env.REPO_URL }}
            - **åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
            - **å†…æ ¸**: ${{ env.KERNEL }}
            - **é»˜è®¤ IP**: ${{ env.IP_ADDR }}
            - **é»˜è®¤å¯†ç **: ${{ env.ROOT_PASSWORD }}
            - **OpenWrt æœ€æ–°å‘è¡Œç‰ˆ**: ${{ env.latest_release }}
            ### ğŸ“’ ç¼–è¯‘ä¿¡æ¯
            - **æäº¤è€…**: ${{ env.COMMIT_AUTHOR }}
            - **æäº¤æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æäº¤ä¿¡æ¯**: ${{ env.COMMIT_MESSAGE }}
            - **Commit SHA**: ${{ env.COMMIT_HASH }}
