name: ğŸ’» X86_64 OpenWrt Builder
# ============================================
# è§¦å‘æ¡ä»¶
# ============================================
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      skip_failed_packages:
        description: "âš ï¸ è·³è¿‡å¤±è´¥çš„åŒ…ç»§ç»­ç¼–è¯‘"
        type: boolean
        default: true
      debug_mode:
        description: "ğŸ› è°ƒè¯•æ¨¡å¼ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰"
        type: boolean
        default: false
      use_cachewrtbuild:
        description: "ğŸ’¾ ä½¿ç”¨ CacheWRTBuild åŠ é€Ÿ"
        type: boolean
        default: true
  push:
    branches: [ main ]
    paths:
      - 'configs/x86_64.config'
      - '.github/workflows/x86_64.yml'
# ============================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ============================================
env:
  # æºç é…ç½®
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64.sh
  
  # ç¼–è¯‘é…ç½®
  CLASH_KERNEL: amd64
  CACHE_TOOLCHAIN: true
  USE_CACHEWRTBUILD: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: X86_64
  
  # ç³»ç»Ÿé…ç½®
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
  
  # ä¼˜åŒ–é…ç½®
  CCACHE_DIR: /tmp/.ccache
  CCACHE_MAXSIZE: 5G
  
# ============================================
# å¹¶å‘æ§åˆ¶
# ============================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
# ============================================
# ä¸»ä»»åŠ¡
# ============================================
jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    
    # é»˜è®¤ shell é…ç½® - ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º
    defaults:
      run:
        shell: bash -euo pipefail {0}
    
    # è¾“å‡ºå®šä¹‰
    outputs:
      status: ${{ steps.compile.outputs.status }}
      firmware_path: ${{ steps.compile.outputs.firmware_path }}
    
    steps:
      # ============================================
      # 1. åŸºç¡€ç¯å¢ƒå‡†å¤‡
      # ============================================
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Initialize Environment Variables
        id: env
        run: |
          # åŸºç¡€æ—¶é—´å˜é‡
          echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "TAG_TIME=$(date +'%Y.%m.%d')" >> $GITHUB_ENV
          
          # ç³»ç»Ÿå˜é‡
          echo "PROC_COUNT=$(nproc)" >> $GITHUB_ENV
          echo "MEM_TOTAL=$(free -m | awk '/^Mem:/{print $2}')" >> $GITHUB_ENV
          echo "WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          
          # æ„å»ºæ ‡è¯†
          echo "RUN_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          
          # è°ƒè¯•æ¨¡å¼
          if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
            echo "BUILD_LOG_LEVEL=V=s" >> $GITHUB_ENV
          else  
            echo "BUILD_LOG_LEVEL=" >> $GITHUB_ENV
          fi
          
      - name: ğŸ“Š System Information
        run: |
          echo "========================================="
          echo "ğŸ“Š System Information"
          echo "========================================="
          echo "CPU Model: $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)"
          echo "CPU Cores: $(nproc)"
          echo "Memory: $(free -h | awk '/^Mem:/{print $2}')"
          echo "Disk Space:"
          df -h
          echo "========================================="
          
      # ============================================
      # 2. ç£ç›˜ç©ºé—´å’Œ Swap ä¼˜åŒ–
      # ============================================
      - name: ğŸ§¹ Free disk space
        uses: sbwml/actions@free-disk
        run: 
          # æ¸…ç† apt ç¼“å­˜
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          
          # è®¾ç½® swap ä¼˜åŒ–å‚æ•°
          sudo sysctl vm.swappiness=10
          sudo sysctl vm.vfs_cache_pressure=50
          
      # ============================================
      # 3. å®‰è£…ç¼–è¯‘ä¾èµ–
      # ============================================
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup

      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
        
      - name: âš¡ Setup Ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-x86_64-${{ env.REPO_BRANCH }}
          max-size: 5G
          
      # ============================================
      # 4. å…‹éš†æºç 
      # ============================================
      - name: ğŸ“¥ Clone OpenWrt Source
        id: clone
        run: |
          # ä½¿ç”¨ CacheWRTBuild åŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [[ "${{ github.event.inputs.use_cachewrtbuild }}" == "true" ]]; then
            echo "ä½¿ç”¨ CacheWRTBuild åŠ é€Ÿä¸‹è½½..."
            bash <(curl -sS https://raw.githubusercontent.com/stupidloud/cachewrtbuild/main/scripts/apply_cache.sh)
            export CACHE_REPO="https://github.com/stupidloud/cachewrtbuild"
            git clone --depth=1 $CACHE_REPO/openwrt.git -b $REPO_BRANCH openwrt
          else
            git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          fi
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # æå–ä»“åº“åç§°
          REPO_NAME=$(basename "$REPO_URL" .git)
          echo "SOURCE_REPO=$REPO_NAME" >> $GITHUB_ENV
          
          # ä¿å­˜æäº¤ä¿¡æ¯
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_ENV  
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git log -1 --pretty=format:'%H')" >> $GITHUB_ENV
          
      # ============================================
      # 5. ç¼“å­˜ç®¡ç†ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      # ============================================
      - name: ğŸ’¾ Cache Management
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/staging_dir
            ${{ env.OPENWRT_PATH }}/build_dir/host*
            ${{ env.OPENWRT_PATH }}/build_dir/toolchain*
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.CCACHE_DIR }}
          key: openwrt-${{ env.REPO_BRANCH }}-x86_64-${{ hashFiles('configs/x86_64.config') }}-${{ env.TAG_TIME }}
          restore-keys: |
            openwrt-${{ env.REPO_BRANCH }}-x86_64-${{ hashFiles('configs/x86_64.config') }}-
            openwrt-${{ env.REPO_BRANCH }}-x86_64-
            
      # ============================================
      # 6. Feeds ç®¡ç†
      # ============================================
      - name: ğŸ“š Update & Install Feeds
        run: |
          cd $OPENWRT_PATH
          
          # å¤åˆ¶è‡ªå®šä¹‰ feeds é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f "$WORKSPACE/feeds.conf.default" ] && cp "$WORKSPACE/feeds.conf.default" .
          
          # æ›´æ–°å’Œå®‰è£… feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      # ============================================
      # 7. è‡ªå®šä¹‰é…ç½®
      # ============================================
      - name: âš™ï¸ Load Custom Configuration
        id: config
        run: |
          cd $OPENWRT_PATH
          
          # å‡†å¤‡é…ç½®æ–‡ä»¶
          [ -e "$WORKSPACE/files" ] && mv "$WORKSPACE/files" files
          [ -e "$WORKSPACE/$CONFIG_FILE" ] && cp "$WORKSPACE/$CONFIG_FILE" .config
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
          chmod +x $WORKSPACE/scripts/*.sh
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›è„šæœ¬ä½¿ç”¨
          export LAN="${{ github.event.inputs.lan_addr }}"
          export ROOT_PASSWORD="${{ github.event.inputs.root_password }}"
          export ENABLE_DOCKER="${{ github.event.inputs.docker }}"
          export ENABLE_SSRP="${{ github.event.inputs.ssrp }}"
          export ENABLE_PASSWALL="${{ github.event.inputs.passwall }}"
          export ENABLE_NIKKI="${{ github.event.inputs.nikki }}"
          export ENABLE_OPENCLASH="${{ github.event.inputs.openclash }}"
          export ENABLE_LUCKY="${{ github.event.inputs.lucky }}"
          export ENABLE_OAF="${{ github.event.inputs.oaf }}"
          
          # æ‰§è¡Œè‡ªå®šä¹‰é…ç½®è„šæœ¬
          $WORKSPACE/$DIY_SCRIPT
          $WORKSPACE/scripts/preset-mihimo-core.sh $CLASH_KERNEL || true
          $WORKSPACE/scripts/preset-adguard-core.sh $CLASH_KERNEL || true
          
          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          TARGET=$(grep '^CONFIG_TARGET_BOARD' .config | cut -d'"' -f2)
          SUBTARGET=$(grep '^CONFIG_TARGET_SUBTARGET' .config | cut -d'"' -f2)
          echo "DEVICE_TARGET=$TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          
          # ç½‘ç»œé…ç½®
          echo "IP_ADDR=${{ github.event.inputs.lan_addr }}" >> $GITHUB_ENV
          
          # è·å–æœ€æ–°ç‰ˆæœ¬å·
          LATEST_TAG=$(curl -sL "https://api.github.com/repos/openwrt/openwrt/releases/latest" | jq -r .tag_name | sed 's/^v//')
          echo "LATEST_RELEASE=${LATEST_TAG:-24.10.0}" >> $GITHUB_ENV
          
      # ============================================
      # 8. ä¸‹è½½åŒ…
      # ============================================
      - name: ğŸ“¥ Download Packages
        run: |
          cd $OPENWRT_PATH
          
          # å¹¶è¡Œä¸‹è½½
          make download -j$((PROC_COUNT + 1))
          
          # æ£€æŸ¥å¹¶æ¸…ç†å¤±è´¥çš„ä¸‹è½½
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          
          # é‡è¯•å¤±è´¥çš„ä¸‹è½½
          make download -j1 || true
          
      # ============================================
      # 9. ç¼–è¯‘å›ºä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      # ============================================
      - name: ğŸ”¨ Compile Firmware
        id: compile
        timeout-minutes: 480
        run: |
          cd $OPENWRT_PATH
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          # æ ¹æ®å†…å­˜å¤§å°åŠ¨æ€è°ƒæ•´ç¼–è¯‘çº¿ç¨‹
          MEM_PER_THREAD=1024  # æ¯ä¸ªçº¿ç¨‹éœ€è¦çš„å†…å­˜(MB)
          MAX_THREADS=$((MEM_TOTAL / MEM_PER_THREAD))
          THREADS=$((PROC_COUNT < MAX_THREADS ? PROC_COUNT : MAX_THREADS))
          
          echo "ç¼–è¯‘é…ç½®ï¼š"
          echo "- CPU æ ¸å¿ƒæ•°: $PROC_COUNT"
          echo "- å¯ç”¨å†…å­˜: ${MEM_TOTAL}MB"
          echo "- ç¼–è¯‘çº¿ç¨‹æ•°: $THREADS"
          
          # ç¼–è¯‘å‡½æ•°
          compile_with_retry() {
            local threads=$1
            echo "å°è¯•ä½¿ç”¨ $threads çº¿ç¨‹ç¼–è¯‘..."
            
            if make -j$threads $BUILD_LOG_LEVEL; then
              return 0
            else
              echo "ç¼–è¯‘å¤±è´¥ï¼Œè¿”å›ç : $?"
              return 1
            fi
          }
          
          # æ¸è¿›å¼ç¼–è¯‘ç­–ç•¥
          if compile_with_retry $THREADS; then
            echo "ç¼–è¯‘æˆåŠŸï¼"
          elif compile_with_retry $((THREADS/2)); then
            echo "é™çº§ç¼–è¯‘æˆåŠŸï¼"
          elif compile_with_retry 2; then
            echo "æœ€å°å¹¶è¡Œç¼–è¯‘æˆåŠŸï¼"
          elif [[ "${{ github.event.inputs.skip_failed_packages }}" == "true" ]]; then
            echo "å°è¯•è·³è¿‡å¤±è´¥çš„åŒ…..."
            make -j1 V=s IGNORE_ERRORS=1 || true
          else
            echo "ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if find bin/targets -name "*.img.gz" -o -name "*.bin" | grep -q .; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "firmware_path=$PWD/bin/targets/*/*" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼"
            exit 1
          fi
          
      # ============================================
      # 10. æ•´ç†æ–‡ä»¶
      # ============================================
      - name: ğŸ“¦ Organize Files
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $OPENWRT_PATH/bin/targets/*/*
          
          # æ˜¾ç¤ºæ ¡éªŒå’Œ
          cat sha256sums
          
          # ä¿å­˜é…ç½®
          cp $OPENWRT_PATH/.config build.config
          
          # æ•´ç†å†…æ ¸åŒ…
          if [ -d packages ]; then
            mkdir -p kernel
            mv packages/* kernel/ 2>/dev/null || true
            tar -czf kernel.tar.gz kernel
            rm -rf kernel
          fi
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf packages feeds.buildinfo version.buildinfo
          
          # æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION=$(grep '^kernel' *.manifest | head -1 | awk '{print $2}')
          echo "KERNEL=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cat > firmware_info.txt <<EOF
          æ„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
          å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION
          ç›®æ ‡å¹³å°: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          é»˜è®¤ IP: ${{ env.IP_ADDR }}
          æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          æäº¤å“ˆå¸Œ: ${{ env.COMMIT_HASH }}
          EOF
          
      # ============================================
      # 11. ä¸Šä¼ äº§ç‰©
      # ============================================
      - name: ğŸ“¤ Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.FILE_DATE }}
          path: |
            ${{ env.OPENWRT_PATH }}/logs/
            ${{ env.OPENWRT_PATH }}/.config
          retention-days: 7
          compression-level: 9
          
      - name: ğŸ“¤ Upload Firmware to Artifacts
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
          
      # ============================================
      # 12. å‘å¸ƒ Release
      # ============================================
      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1
        with:
          name: OpenWrt ${{ env.DEVICE_TARGET }} - ${{ env.TAG_TIME }}
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.TAG_TIME }}
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            ${{ env.FIRMWARE_PATH }}/*.img.gz
            ${{ env.FIRMWARE_PATH }}/*.bin
            ${{ env.FIRMWARE_PATH }}/*.vmdk
            ${{ env.FIRMWARE_PATH }}/sha256sums
            ${{ env.FIRMWARE_PATH }}/build.config
            ${{ env.FIRMWARE_PATH }}/firmware_info.txt
            ${{ env.FIRMWARE_PATH }}/kernel.tar.gz
          body: |
            ## ğŸ¯ OpenWrt å›ºä»¶
            
            ### ğŸ“Š ç¼–è¯‘ä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | ğŸ·ï¸ **æ ‡ç­¾** | `${{ env.FIRMWARE_TAG }}-${{ env.TAG_TIME }}` |
            | ğŸ“… **ç¼–è¯‘æ—¶é—´** | ${{ env.BUILD_DATE }} |
            | ğŸ¯ **ç›®æ ‡å¹³å°** | `${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}` |
            | ğŸ§ **å†…æ ¸ç‰ˆæœ¬** | `${{ env.KERNEL }}` |
            | ğŸŒ **é»˜è®¤ IP** | `${{ env.IP_ADDR }}` |
            | ğŸ”‘ **é»˜è®¤å¯†ç ** | `${{ github.event.inputs.root_password }}` |
            
            ### ğŸ“¦ åŒ…å«æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker && 'âœ…' || 'âŒ' }} |
            | SSR Plus+ | ${{ github.event.inputs.ssrp && 'âœ…' || 'âŒ' }} |
            | Passwall | ${{ github.event.inputs.passwall && 'âœ…' || 'âŒ' }} |
            | OpenClash | ${{ github.event.inputs.openclash && 'âœ…' || 'âŒ' }} |
            | Lucky | ${{ github.event.inputs.lucky && 'âœ…' || 'âŒ' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf && 'âœ…' || 'âŒ' }} |
            
            ### ğŸ“ æºç ä¿¡æ¯
            - **ä»“åº“**: [`${{ env.REPO_URL }}`](${{ env.REPO_URL }})
            - **åˆ†æ”¯**: `${{ env.REPO_BRANCH }}`
            - **æäº¤**: `${{ env.COMMIT_HASH }}`
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **è¯´æ˜**: ${{ env.COMMIT_MESSAGE }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            1. `*.img.gz` - å›ºä»¶é•œåƒæ–‡ä»¶ï¼ˆéœ€è§£å‹åå†™å…¥ï¼‰
            2. `sha256sums` - æ–‡ä»¶æ ¡éªŒå’Œ
            3. `build.config` - ç¼–è¯‘é…ç½®æ–‡ä»¶
            4. `kernel.tar.gz` - å†…æ ¸æ¨¡å—åŒ…
            
            ### âš¡ åˆ·æœºæç¤º
            ```bash
            # è§£å‹å›ºä»¶
            gunzip openwrt-*.img.gz
            
            # å†™å…¥è®¾å¤‡ï¼ˆè¯·æ›¿æ¢ /dev/sdX ä¸ºå®é™…è®¾å¤‡ï¼‰
            dd if=openwrt-*.img of=/dev/sdX bs=4M status=progress
