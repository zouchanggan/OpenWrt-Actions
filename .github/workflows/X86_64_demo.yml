name: ğŸ’» X86_64_demo
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "è®¾ç½®é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "é»˜è®¤ root å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ passwordï¼‰"
        default: "password"
        required: false
        type: string
      # ä½¿ç”¨JSONæ•°ç»„ç®€åŒ–æ’ä»¶é€‰æ‹©
      plugins:
        description: "é€‰æ‹©è¦ç¼–è¯‘çš„æ’ä»¶ (JSONæ•°ç»„æ ¼å¼)"
        default: '["docker", "ssrp", "passwall", "nikki", "openclash", "lucky", "oaf"]'
        required: false
        type: string
env:
  REPO_URL: openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CACHE_VER: v4
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64.sh
  CLASH_KERNEL: amd64
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: X86_64
  # æ–°å¢ï¼šç»Ÿä¸€è·¯å¾„ç®¡ç†
  MAIN_REPO_PATH: ${{ github.workspace }}/main-repo
  OPENWRT_PATH: ${{ github.workspace }}/openwrt
jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    
    # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼ˆå¦‚æœéœ€è¦å¤šæ¶æ„æ„å»ºï¼‰
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
    
    steps:
      # ========== ç¯å¢ƒå‡†å¤‡é˜¶æ®µ ==========
      - name: ğŸ”§ Initialize Build Environment
        run: |
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone Asia/Shanghai
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p $HOME/.ccache
          echo "max_size = 10G" > $HOME/.ccache/ccache.conf
          
          # å®‰è£…é¢å¤–ä¾èµ–ï¼ˆæå‰å®‰è£…ï¼Œå‡å°‘åç»­ç­‰å¾…ï¼‰
          sudo apt-get update
          sudo apt-get install -y jq parallel
          
          # è®¾ç½® swapï¼ˆå¢åŠ ç¼–è¯‘å†…å­˜ï¼‰
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      - name: ğŸ§¹ Maximize Build Space
        uses: sbwml/actions@free-disk
        with:
          build-mount-path: /builder
          # æ–°å¢ï¼šæ›´æ¿€è¿›çš„æ¸…ç†ç­–ç•¥
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
      # ========== æºç è·å–é˜¶æ®µ ==========
      - name: ğŸ“¦ Checkout OpenWrt Source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO_URL }}
          ref: ${{ env.REPO_BRANCH }}
          path: openwrt
          fetch-depth: 1
          # ä½¿ç”¨ sparse-checkout å‡å°‘å…‹éš†å¤§å°
          sparse-checkout: |
            /*
            !.git/hooks
            !.git/refs/remotes
      # ========== æ„å»ºå·¥å…·å‡†å¤‡ ==========
      - name: ğŸ› ï¸ Setup Build Tools
        run: |
          # å¹¶è¡Œå®‰è£…æ„å»ºå·¥å…·
          parallel -j2 ::: \
            "cd ${{ env.OPENWRT_PATH }} && bash ${{ env.MAIN_REPO_PATH }}/scripts/install-build-deps.sh" \
            "cd ${{ env.OPENWRT_PATH }} && bash ${{ env.MAIN_REPO_PATH }}/scripts/install-llvm.sh"
      # ========== ç¼“å­˜ä¼˜åŒ– ==========
      - name: ğŸ’¾ Restore Build Cache
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.OPENWRT_PATH }}/staging_dir/host
            ${{ env.OPENWRT_PATH }}/staging_dir/toolchain-*
            ${{ env.OPENWRT_PATH }}/build_dir/host
            ${{ env.OPENWRT_PATH }}/build_dir/toolchain-*
          key: build-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}-${{ hashFiles('main-repo/configs/**') }}
          restore-keys: |
            build-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}-
            build-${{ runner.os }}-${{ env.CACHE_VER }}-
      - name: ğŸ”„ Setup Ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ matrix.arch }}-${{ env.CACHE_VER }}
          max-size: 10G
          save: true
      # ========== Feeds å¤„ç† ==========
      - name: ğŸ“š Install Feeds
        run: |
          cd ${{ env.OPENWRT_PATH }}
          
          # å¤åˆ¶ feeds é…ç½®
          [ -f "${{ env.MAIN_REPO_PATH }}/feeds.conf.default" ] && \
            cp "${{ env.MAIN_REPO_PATH }}/feeds.conf.default" .
          
          # å¹¶è¡Œæ›´æ–°å’Œå®‰è£… feeds
          ./scripts/feeds update -a -j$(nproc)
          ./scripts/feeds install -a -j$(nproc)
      # ========== é…ç½®ç”Ÿæˆ ==========
      - name: âš™ï¸ Generate Configuration
        id: config
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          PLUGINS: ${{ github.event.inputs.plugins }}
        run: |
          cd ${{ env.OPENWRT_PATH }}
          
          # åŸºç¡€é…ç½®
          cp "${{ env.MAIN_REPO_PATH }}/${{ env.CONFIG_FILE }}" .config
          
          # åŠ¨æ€æ·»åŠ æ’ä»¶é…ç½®ï¼ˆä½¿ç”¨ Python è„šæœ¬å¤„ç† JSONï¼‰
          python3 << 'EOF'
          import json
          import os
          import subprocess
          
          plugins = json.loads(os.environ.get('PLUGINS', '[]'))
          config_mapping = {
              'docker': 'configs/config-docker.txt',
              'ssrp': 'config-ssrp.txt',
              'passwall': 'config-passwall.txt',
              'nikki': 'config-nikki.txt',
              'openclash': 'config-openclash.txt',
              'lucky': 'config-lucky.txt',
              'oaf': 'config-oaf.txt'
          }
          
          for plugin in plugins:
              if plugin in config_mapping:
                  config_file = f"{os.environ['MAIN_REPO_PATH']}/{config_mapping[plugin]}"
                  if os.path.exists(config_file):
                      subprocess.run(f"cat {config_file} >> .config", shell=True)
                      print(f"âœ… Added {plugin} configuration")
          EOF
          
          # æ‰§è¡Œ DIY è„šæœ¬
          chmod +x "${{ env.MAIN_REPO_PATH }}/${{ env.DIY_SCRIPT }}"
          "${{ env.MAIN_REPO_PATH }}/${{ env.DIY_SCRIPT }}"
          
          # å¹¶è¡Œä¸‹è½½æ ¸å¿ƒæ–‡ä»¶
          parallel -j2 ::: \
            "${{ env.MAIN_REPO_PATH }}/scripts/preset-mihomo-core.sh ${{ env.CLASH_KERNEL }}" \
            "${{ env.MAIN_REPO_PATH }}/scripts/preset-adguard-core.sh ${{ env.CLASH_KERNEL }}"
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make defconfig
          
          # æå–è®¾å¤‡ä¿¡æ¯
          DEVICE_TARGET=$(grep -E "^CONFIG_TARGET_[a-zA-Z0-9_]+=" .config | grep "=y$" | head -n1 | sed -r 's/.*TARGET_(.*)=y/\1/')
          DEVICE_SUBTARGET=$(grep -E "^CONFIG_TARGET_${DEVICE_TARGET}_[a-zA-Z0-9_]+=" .config | grep "=y$" | head -n1 | sed -r "s/.*${DEVICE_TARGET}_(.*)=y/\1/")
          
          # è¾“å‡ºç¯å¢ƒå˜é‡
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
            echo "IP_ADDR=$LAN"
            echo "COMMIT_INFO=$(git -C . log -1 --pretty=format:'%an | %ci | %s | %H')"
            echo "BUILD_DATE=$(date +%Y.%m.%d-%H%M)"
          } >> $GITHUB_ENV
      # ========== ä¸‹è½½åŒ… ==========
      - name: ğŸ“¥ Download Packages
        run: |
          cd ${{ env.OPENWRT_PATH }}
          
          # ä½¿ç”¨æ›´å¤šçº¿ç¨‹ä¸‹è½½ï¼Œå¹¶æ·»åŠ é‡è¯•æœºåˆ¶
          make download -j$(($(nproc) * 2)) || \
          make download -j$(nproc) || \
          make download -j1 V=s
      # ========== ç¼–è¯‘å›ºä»¶ ==========
      - name: ğŸ”¨ Compile Firmware
        id: compile
        run: |
          cd ${{ env.OPENWRT_PATH }}
          
          echo "::group::Compilation Details"
          echo "CPU Cores: $(nproc)"
          echo "Memory: $(free -h)"
          echo "Disk Space: $(df -h)"
          echo "::endgroup::"
          
          # ä½¿ç”¨æ›´ä¼˜åŒ–çš„ç¼–è¯‘ç­–ç•¥
          JOBS=$(($(nproc) + 1))
          
          # å…ˆç¼–è¯‘å·¥å…·é“¾ï¼ˆå¦‚æœéœ€è¦ï¼‰
          make tools/compile -j${JOBS} || make tools/compile -j1 V=s
          make toolchain/compile -j${JOBS} || make toolchain/compile -j1 V=s
          
          # ç¼–è¯‘å›ºä»¶
          make -j${JOBS} || \
          make -j$((JOBS / 2)) || \
          make -j1 V=s
          
          # æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL=$(find bin/targets -name "*.manifest" -exec grep '^kernel' {} \; | head -n1 | awk '{print $3}' | cut -d- -f2)
          echo "KERNEL=$KERNEL" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
      # ========== ä¿å­˜ç¼“å­˜ ==========
      - name: ğŸ’¾ Save Build Cache
        if: steps.compile.outputs.status == 'success'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.OPENWRT_PATH }}/staging_dir/host
            ${{ env.OPENWRT_PATH }}/staging_dir/toolchain-*
            ${{ env.OPENWRT_PATH }}/build_dir/host
            ${{ env.OPENWRT_PATH }}/build_dir/toolchain-*
          key: build-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}-${{ hashFiles('main-repo/configs/**') }}
      # ========== æ–‡ä»¶æ•´ç† ==========
      - name: ğŸ“ Organize Files
        if: steps.compile.outputs.status == 'success'
        run: |
          cd ${{ env.OPENWRT_PATH }}/bin/targets/*/*
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -f sha256sums packages* *.buildinfo *.json
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp ${{ env.OPENWRT_PATH }}/.config build.config
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶ï¼ˆæ·»åŠ æ—¶é—´æˆ³ï¼‰
          for file in openwrt-*.img.gz openwrt-*.vmdk; do
            [ -f "$file" ] && mv "$file" "${file%.img.gz}-${{ env.BUILD_DATE }}.img.gz" 2>/dev/null || true
          done
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
      # ========== ä¸Šä¼ å›ºä»¶ ==========
      - name: ğŸš€ Upload Firmware to Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: "OpenWrt ${{ env.BUILD_DATE }} for ${{ matrix.arch }}"
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.BUILD_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware Information
            
            ### ğŸ“‹ Build Details
            | Item | Value |
            |------|-------|
            | ğŸ—ï¸ Architecture | `${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}` |
            | ğŸŒ Default IP | `${{ env.IP_ADDR }}` |
            | ğŸ”‘ Root Password | `${{ github.event.inputs.root_password }}` |
            | ğŸ§ Kernel Version | `${{ env.KERNEL }}` |
            | ğŸ“… Build Date | `${{ env.BUILD_DATE }}` |
            | ğŸ”Œ Plugins | `${{ github.event.inputs.plugins }}` |
            
            ### ğŸ“¦ Source Information
            - **Repository:** `${{ env.REPO_URL }}`
            - **Branch:** `${{ env.REPO_BRANCH }}`
            - **Commit:** `${{ env.COMMIT_INFO }}`
            
            ### ğŸ“ Changelog
            Please check the commit history [<sup>1</sup>](https://github.com/${{ env.REPO_URL }}/commits/${{ env.REPO_BRANCH }}) for details.
      # ========== æ¸…ç†å’ŒæŠ¥å‘Š ==========
      - name: ğŸ“Š Build Report
        if: always()
        run: |
          echo "::group::Build Summary"
          echo "Build Status: ${{ steps.compile.outputs.status }}"
          echo "Disk Usage:"
          df -hT
          echo "Ccache Statistics:"
          ccache -s
          echo "::endgroup::"
