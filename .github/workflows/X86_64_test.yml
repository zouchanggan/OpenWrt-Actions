#=================================================
# ä¼˜åŒ–ç‰ˆï¼šä¿æŒç¼“å­˜76%+å‘½ä¸­ç‡ï¼Œæ¶ˆé™¤å†—ä½™ä»£ç 
# Author: P3TERX (Optimized - Redundancy Removed)
# Version: v13-with-toolchain-validation
#=================================================
name: ğŸ’» Build OpenWrt test

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.200"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      use_prebuilt_toolchain:
        description: "ğŸ“¦ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾"
        type: boolean
        default: true
      force_rebuild_toolchain:
        description: "ğŸ”¨ å¼ºåˆ¶é‡æ–°ç¼–è¯‘å·¥å…·é“¾"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false

jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
    
    steps:
      # ============================================
      # 1. ç¯å¢ƒåˆå§‹åŒ–
      # ============================================
      - name: ğŸ”§ Setup Environment
        id: env
        run: |
          # æ—¶åŒºä¸ Git åŸºæœ¬é…ç½®
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ„å»ºä¿¡æ¯
          VERSION=$(date +'%Y.%m.%d')
          DATE=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # è‡ªåŠ¨å¹¶è¡Œè®¡ç®—
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 2))
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          
          # ğŸ”¥ å¤šå±‚ç¼“å­˜é”®ç­–ç•¥
          MONTH_KEY=$(date +'%Y%m')
          WEEK_KEY=$(date +'%Y%U')
          DAY_KEY=$(date +'%Y%m%d')
          
          # æ’ä»¶ç»„åˆé”®
          PLUGINS_KEY="${{ github.event.inputs.docker }}-${{ github.event.inputs.ssrp }}-${{ github.event.inputs.passwall }}-${{ github.event.inputs.nikki }}-${{ github.event.inputs.openclash }}-${{ github.event.inputs.lucky }}-${{ github.event.inputs.oaf }}"
          PLUGINS_HASH=$(echo "$PLUGINS_KEY" | sha256sum | cut -c1-8)
          
          # æºç ç‰ˆæœ¬é”®
          SOURCE_KEY="${REPO_BRANCH}-$(echo "${REPO_URL}" | sha256sum | cut -c1-6)"
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo "====================================="
          echo "ğŸ“Š System Information"
          echo "====================================="
          echo "CPU: $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)"
          echo "Cores: $PROC_COUNT | Memory: ${MEM_GB}GB | Jobs: $JOBS"
          echo "OS: $(lsb_release -ds) | Kernel: $(uname -r)"
          echo "Build: $VERSION ($BUILD_ID)"
          echo "---"
          echo "ğŸ”‘ Cache Keys:"
          echo "  Month: $MONTH_KEY | Week: $WEEK_KEY | Day: $DAY_KEY"
          echo "  Plugins: $PLUGINS_HASH | Source: $SOURCE_KEY"
          echo "====================================="
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          {
            echo "BUILD_VERSION=$VERSION"
            echo "BUILD_DATE=$DATE"
            echo "BUILD_ID=$BUILD_ID"
            echo "FILE_DATE=$FILE_DATE"
            echo "COMPILE_JOBS=$JOBS"
            echo "MONTH_KEY=$MONTH_KEY"
            echo "WEEK_KEY=$WEEK_KEY"
            echo "DAY_KEY=$DAY_KEY"
            echo "PLUGINS_HASH=$PLUGINS_HASH"
            echo "SOURCE_KEY=$SOURCE_KEY"
          } >> $GITHUB_ENV
      
      # ============================================
      # 2. ç³»ç»Ÿä¼˜åŒ–
      # ============================================
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: ğŸ’¾ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          EOF
          sudo sysctl -p
          echo "Memory status:"
          free -h
      
      # ============================================
      # 3. ä»£ç æ£€å‡º
      # ============================================
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # ============================================
      # 4. æ„å»ºä¾èµ–å®‰è£…
      # ============================================
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      
      # ============================================
      # 5. æºç å‡†å¤‡ä¸ä¿¡æ¯é‡‡é›†
      # ============================================
      - name: ğŸ“¥ Prepare OpenWrt Source
        run: |
          if ! git ls-remote --heads "$REPO_URL" "$REPO_BRANCH" &>/dev/null; then
            echo "âŒ Branch $REPO_BRANCH not found in $REPO_URL"
            git ls-remote --heads "$REPO_URL" | head -10
            exit 1
          fi
          
          echo "ğŸ”„ Cloning fresh OpenWrt source..."
          rm -rf openwrt
          
          for attempt in 1 2 3; do
            echo "ğŸ“¥ Clone attempt $attempt/3..."
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "âŒ Clone attempt $attempt failed"
            rm -rf openwrt
            if [ $attempt -lt 3 ]; then
              sleep 10
            else
              echo "âŒ All clone attempts failed"
              exit 1
            fi
          done
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # è·å–æäº¤ä¿¡æ¯
          if git log -1 --pretty=format:'%an|%ci|%s|%H' &>/dev/null; then
            COMMIT_INFO=$(git log -1 --pretty=format:'%an|%ci|%s|%H')
            IFS='|' read -r AUTHOR DATE MESSAGE HASH <<< "$COMMIT_INFO"
          else
            AUTHOR="Unknown"; DATE="Unknown"; MESSAGE="Unknown"; HASH="Unknown"
          fi
          
          {
            echo "COMMIT_AUTHOR=${AUTHOR}"
            echo "COMMIT_DATE=${DATE}"
            echo "COMMIT_MESSAGE=${MESSAGE}"
            echo "COMMIT_HASH=${HASH}"
          } >> $GITHUB_ENV

      # ============================================
      # 6. ğŸ”¥ ä¸‹è½½å¹¶åº”ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾ï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰
      # ============================================
      - name: ğŸ§® Calculate Toolchain Hash
        id: toolchain_meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd "$OPENWRT_PATH"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Calculating Toolchain Configuration Hash"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è®¡ç®—å·¥å…·é“¾é…ç½®å“ˆå¸Œï¼ˆåŸºäºç›®æ ‡å¹³å°å’Œåˆ†æ”¯ï¼‰
          TOOLCHAIN_HASH=$(echo "${REPO_BRANCH}-x86/64-$(uname -m)" | md5sum | cut -d' ' -f1 | cut -c1-40)
          
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          echo "TOOLCHAIN_HASH=$TOOLCHAIN_HASH" >> $GITHUB_ENV
          
          echo "ğŸ“‹ Toolchain Information:"
          echo "  Branch: $REPO_BRANCH"
          echo "  Target: x86/64"
          echo "  Host Arch: $(uname -m)"
          echo "  Hash: $TOOLCHAIN_HASH"
          echo ""
          
          # æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨
          RELEASE_TAG="toolchain-${TOOLCHAIN_HASH}"
          echo "ğŸ” Checking for prebuilt toolchain release: $RELEASE_TAG"
          
          if gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found prebuilt toolchain release"
            
            # åˆ—å‡º Release ä¸­çš„æ–‡ä»¶
            echo ""
            echo "ğŸ“¦ Available files in release:"
            gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" --json assets --jq '.assets[].name' || true
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No prebuilt toolchain release found"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¥ Download & Restore Prebuilt Toolchain
        id: download_toolchain
        if: |
          steps.toolchain_meta.outputs.exists == 'true' &&
          github.event.inputs.force_clean != 'true' &&
          github.event.inputs.use_prebuilt_toolchain == 'true' &&
          github.event.inputs.force_rebuild_toolchain != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ Downloading Prebuilt Toolchain"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TOOLCHAIN_HASH="${{ steps.toolchain_meta.outputs.toolchain_hash }}"
          RELEASE_TAG="toolchain-${TOOLCHAIN_HASH}"
          
          echo "ğŸ“‹ Download Information:"
          echo "  Release Tag: $RELEASE_TAG"
          echo "  Repository: ${{ github.repository }}"
          echo ""
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/toolchain-download
          
          # ä¸‹è½½å·¥å…·é“¾æ–‡ä»¶
          echo "ğŸ“¥ Downloading toolchain archive..."
          if ! gh release download "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --pattern "toolchain-*.tar.gz" \
            --dir /tmp/toolchain-download 2>&1; then
            echo "âŒ Failed to download toolchain files"
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            rm -rf /tmp/toolchain-download
            exit 0
          fi
          
          # æŸ¥æ‰¾ä¸‹è½½çš„æ–‡ä»¶
          ARCHIVE=$(find /tmp/toolchain-download -maxdepth 1 -name "toolchain-*.tar.gz" -type f | head -1)
          
          if [ -z "$ARCHIVE" ] || [ ! -f "$ARCHIVE" ]; then
            echo "âŒ No toolchain archive found after download"
            echo "ğŸ“‚ Downloaded files:"
            ls -lah /tmp/toolchain-download/ || echo "  (directory empty)"
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            rm -rf /tmp/toolchain-download
            exit 0
          fi
          
          echo "âœ… Downloaded: $(basename "$ARCHIVE")"
          echo "ğŸ“Š Archive size: $(du -h "$ARCHIVE" | cut -f1)"
          echo ""
          
          # ğŸ”¥ ä¿®å¤ï¼šéªŒè¯å‹ç¼©åŒ…å®Œæ•´æ€§
          echo "ğŸ” Verifying archive integrity..."
          if ! tar -tzf "$ARCHIVE" > /dev/null 2>&1; then
            echo "âŒ Archive is corrupted or invalid"
            rm -rf /tmp/toolchain-download
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… Archive integrity verified"
          echo ""
          
          # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…ç®¡é“é”™è¯¯
          echo "ğŸ” Inspecting archive structure..."
          tar -tzf "$ARCHIVE" > /tmp/archive-list.txt 2>&1 || true
          
          echo "First 20 files in archive:"
          head -20 /tmp/archive-list.txt
          echo ""
          
          FIRST_DIR=$(head -1 /tmp/archive-list.txt | cut -d'/' -f1)
          echo "ğŸ“‚ Archive root directory: $FIRST_DIR"
          
          rm -f /tmp/archive-list.txt
          
          # è¿›å…¥ OpenWrt ç›®å½•
          cd "$OPENWRT_PATH"
          
          # å¤‡ä»½ç°æœ‰é…ç½®
          if [ -f ".config" ]; then
            echo "ğŸ“„ Backing up existing .config"
            cp .config .config.backup
          fi
          
          # ğŸ”¥ ä¿®å¤ï¼šæ™ºèƒ½è§£å‹ç­–ç•¥
          echo ""
          echo "ğŸ“¦ Extracting toolchain to $OPENWRT_PATH..."
          
          if [ "$FIRST_DIR" = "staging_dir" ] || [ "$FIRST_DIR" = "build_dir" ] || [ "$FIRST_DIR" = "toolchain-info.txt" ]; then
            echo "âœ… Direct structure detected, extracting without strip-components"
            if ! tar -xzf "$ARCHIVE" -C "$OPENWRT_PATH" 2>&1; then
              echo "âŒ Extraction failed"
              rm -rf /tmp/toolchain-download
              [ -f ".config.backup" ] && mv .config.backup .config
              echo "use_toolchain=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "âœ… Nested structure detected, extracting with strip-components=1"
            if ! tar -xzf "$ARCHIVE" --strip-components=1 -C "$OPENWRT_PATH" 2>&1; then
              echo "âŒ Extraction failed"
              rm -rf /tmp/toolchain-download
              [ -f ".config.backup" ] && mv .config.backup .config
              echo "use_toolchain=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "âœ… Extraction completed"
          echo ""
          
          # ğŸ”¥ å…³é”®ï¼šéªŒè¯å·¥å…·é“¾ç›®å½•
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Verifying Toolchain Directories"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TOOLCHAIN_FOUND=false
          
          # æ£€æŸ¥ staging_dir
          if [ -d "$OPENWRT_PATH/staging_dir" ]; then
            TOOLCHAIN_COUNT=$(find "$OPENWRT_PATH/staging_dir" -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | wc -l)
            if [ "$TOOLCHAIN_COUNT" -gt 0 ]; then
              echo "âœ… Found $TOOLCHAIN_COUNT toolchain directory(ies) in staging_dir"
              find "$OPENWRT_PATH/staging_dir" -maxdepth 1 -type d -name "toolchain-*" -exec basename {} \;
              TOOLCHAIN_FOUND=true
            fi
          fi
          
          # æ£€æŸ¥ build_dir
          if [ -d "$OPENWRT_PATH/build_dir" ]; then
            BUILD_TOOLCHAIN_COUNT=$(find "$OPENWRT_PATH/build_dir" -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | wc -l)
            if [ "$BUILD_TOOLCHAIN_COUNT" -gt 0 ]; then
              echo "âœ… Found $BUILD_TOOLCHAIN_COUNT toolchain directory(ies) in build_dir"
              find "$OPENWRT_PATH/build_dir" -maxdepth 1 -type d -name "toolchain-*" -exec basename {} \;
              TOOLCHAIN_FOUND=true
            fi
          fi
          
          if [ "$TOOLCHAIN_FOUND" = false ]; then
            echo "âŒ Toolchain directories not found after extraction"
            echo ""
            echo "ğŸ“‚ Current directory structure:"
            ls -lah "$OPENWRT_PATH/" | head -20 || true
            echo ""
            echo "âš ï¸ Will build toolchain from source"
            
            # æ¢å¤é…ç½®
            [ -f ".config.backup" ] && mv .config.backup .config
            rm -rf /tmp/toolchain-download
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo ""
          
          # ğŸ”¥ å…³é”®ï¼šéªŒè¯å·¥å…·é“¾å®Œæ•´æ€§
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Validating Toolchain Integrity"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TOOLCHAIN_DIR=$(find "$OPENWRT_PATH/staging_dir" -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ Toolchain directory not found"
            [ -f ".config.backup" ] && mv .config.backup .config
            rm -rf /tmp/toolchain-download
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“‚ Toolchain directory: $(basename "$TOOLCHAIN_DIR")"
          echo ""
          
          # æ£€æŸ¥ç¼–è¯‘å™¨
          GCC_BIN="$TOOLCHAIN_DIR/bin/x86_64-openwrt-linux-gcc"
          
          if [ ! -f "$GCC_BIN" ]; then
            echo "âŒ GCC not found: $GCC_BIN"
            echo "âš ï¸ Toolchain appears incomplete, will rebuild from source"
            rm -rf "$TOOLCHAIN_DIR"
            [ -f ".config.backup" ] && mv .config.backup .config
            rm -rf /tmp/toolchain-download
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ä¿®å¤æƒé™
          if [ ! -x "$GCC_BIN" ]; then
            echo "âš ï¸ Fixing GCC permissions..."
            chmod +x "$GCC_BIN"
          fi
          
          # æµ‹è¯•ç¼–è¯‘å™¨
          echo "ğŸ§ª Testing compiler..."
          if ! "$GCC_BIN" --version > /tmp/gcc-test.log 2>&1; then
            echo "âŒ Compiler test failed"
            echo "Error output:"
            cat /tmp/gcc-test.log
            echo ""
            echo "âš ï¸ Toolchain is incompatible with current environment"
            rm -rf "$TOOLCHAIN_DIR"
            [ -f ".config.backup" ] && mv .config.backup .config
            rm -rf /tmp/toolchain-download /tmp/gcc-test.log
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          GCC_VERSION=$("$GCC_BIN" --version | head -1)
          echo "âœ… Compiler test passed: $GCC_VERSION"
          rm -f /tmp/gcc-test.log
          echo ""
          
          # æ£€æŸ¥å…³é”®å·¥å…·
          echo "ğŸ” Checking required tools..."
          
          REQUIRED_TOOLS=(
            "x86_64-openwrt-linux-g++"
            "x86_64-openwrt-linux-ld"
            "x86_64-openwrt-linux-ar"
            "x86_64-openwrt-linux-as"
            "x86_64-openwrt-linux-ranlib"
            "x86_64-openwrt-linux-strip"
            "x86_64-openwrt-linux-objcopy"
            "x86_64-openwrt-linux-objdump"
          )
          
          MISSING_TOOLS=0
          for tool in "${REQUIRED_TOOLS[@]}"; do
            TOOL_PATH="$TOOLCHAIN_DIR/bin/$tool"
            if [ ! -f "$TOOL_PATH" ]; then
              echo "âŒ Missing tool: $tool"
              MISSING_TOOLS=$((MISSING_TOOLS + 1))
            else
              chmod +x "$TOOL_PATH" 2>/dev/null || true
              echo "âœ… Found: $tool"
            fi
          done
          
          if [ $MISSING_TOOLS -gt 0 ]; then
            echo ""
            echo "âŒ Toolchain incomplete: $MISSING_TOOLS missing tools"
            echo "âš ï¸ Will rebuild toolchain from source"
            rm -rf "$TOOLCHAIN_DIR"
            [ -f ".config.backup" ] && mv .config.backup .config
            rm -rf /tmp/toolchain-download
            echo "use_toolchain=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo ""
          echo "âœ… All required tools present and executable"
          echo ""
          
          # æ ‡è®°å·¥å…·é“¾å·²éªŒè¯
          touch "$TOOLCHAIN_DIR/.validated"
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" > "$TOOLCHAIN_DIR/.validated"
          
          # æ˜¾ç¤ºå·¥å…·é“¾ä¿¡æ¯
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Toolchain Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f "$OPENWRT_PATH/toolchain-info.txt" ]; then
            cat "$OPENWRT_PATH/toolchain-info.txt"
          else
            echo "OpenWrt Version: $REPO_BRANCH"
            echo "Target Platform: x86/64"
            echo "Toolchain Hash: $TOOLCHAIN_HASH"
            echo "GCC Version: $GCC_VERSION"
            echo "Validated: $(cat "$TOOLCHAIN_DIR/.validated")"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Prebuilt Toolchain Validated and Ready"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ¢å¤é…ç½®
          [ -f ".config.backup" ] && mv .config.backup .config
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/toolchain-download
          
          echo "use_toolchain=true" >> $GITHUB_OUTPUT
          echo "TOOLCHAIN_READY=true" >> $GITHUB_ENV

      # ============================================
      # 6.5. å·¥å…·é“¾çŠ¶æ€æ£€æŸ¥
      # ============================================
      - name: ğŸ” Check Toolchain Status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Toolchain Status Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "${{ steps.download_toolchain.outputs.use_toolchain }}" = "true" ]; then
            echo "âœ… Status: Prebuilt toolchain loaded"
            echo "âš¡ Build time will be reduced by ~25 minutes"
            echo "ğŸ”‘ Toolchain Hash: ${{ steps.toolchain_meta.outputs.toolchain_hash }}"
            
            TOOLCHAIN_DIR=$(find "$OPENWRT_PATH/staging_dir" -maxdepth 1 -type d -name "toolchain-*" | head -1)
            
            if [ -f "$TOOLCHAIN_DIR/.validated" ]; then
              echo "âœ… Validation timestamp: $(cat "$TOOLCHAIN_DIR/.validated")"
            fi
            
            echo ""
            echo "ğŸ“Š Current staging_dir status:"
            echo "  Total size: $(du -sh "$OPENWRT_PATH/staging_dir" 2>/dev/null | cut -f1)"
            echo "  Contents:"
            ls -lh "$OPENWRT_PATH/staging_dir/" 2>/dev/null | grep "^d" | awk '{print "    " $0}'
            
          else
            echo "âš ï¸ Status: Will build toolchain from source"
            echo "â±ï¸ This will add ~25-30 minutes to build time"
            
            if [ "${{ steps.toolchain_meta.outputs.exists }}" = "true" ]; then
              echo "ğŸ“ Reason: Toolchain validation failed"
            else
              echo "ğŸ“ Reason: No prebuilt toolchain available"
            fi
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # ============================================
      # 7. ğŸ”¥ å¤šå±‚ç¼“å­˜ç­–ç•¥ï¼ˆä¿æŒåŸæœ‰7ä¸ªç¼“å­˜ï¼‰
      # ============================================
      
      # å·¥å…·é“¾ç¼“å­˜ - å¦‚æœä½¿ç”¨äº†é¢„ç¼–è¯‘å·¥å…·é“¾ï¼Œè·³è¿‡æ­¤ç¼“å­˜
      - name: â˜ï¸ Cache Toolchain (Monthly)
        if: |
          github.event.inputs.force_clean != 'true' &&
          steps.download_toolchain.outputs.use_toolchain != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.SOURCE_KEY }}-${{ env.MONTH_KEY }}-v13
          restore-keys: |
            toolchain-${{ env.SOURCE_KEY }}-${{ env.MONTH_KEY }}-
            toolchain-${{ env.SOURCE_KEY }}-
            toolchain-${{ env.REPO_BRANCH }}-
      
      # Staging ç›®å½•ç¼“å­˜ - å‘¨åº¦æ›´æ–°
      - name: â˜ï¸ Cache Staging Directory (Weekly)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
            openwrt/staging_dir/packages
          key: staging-${{ env.SOURCE_KEY }}-${{ env.WEEK_KEY }}-v13
          restore-keys: |
            staging-${{ env.SOURCE_KEY }}-${{ env.WEEK_KEY }}-
            staging-${{ env.SOURCE_KEY }}-
            staging-${{ env.REPO_BRANCH }}-
      
      # æ„å»ºä¸»æœºç¼“å­˜ - åŸºäºæ’ä»¶ç»„åˆ
      - name: â˜ï¸ Cache Build Host (Plugin-based)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/host*
          key: buildhost-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-${{ env.WEEK_KEY }}-v13
          restore-keys: |
            buildhost-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-
            buildhost-${{ env.SOURCE_KEY }}-
            buildhost-${{ env.REPO_BRANCH }}-
      
      # ä¸‹è½½ç¼“å­˜ - é•¿æœŸæœ‰æ•ˆ
      - name: â˜ï¸ Cache Downloads (Long-term)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.SOURCE_KEY }}-${{ env.MONTH_KEY }}-v13
          restore-keys: |
            downloads-${{ env.SOURCE_KEY }}-
            downloads-${{ env.REPO_BRANCH }}-
      
      # ccache ç¼“å­˜ - æœ€æ¿€è¿›çš„ç¼“å­˜
      - name: â˜ï¸ Cache ccache (Aggressive)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-${{ env.WEEK_KEY }}-v13
          restore-keys: |
            ccache-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-
            ccache-${{ env.SOURCE_KEY }}-
            ccache-${{ env.REPO_BRANCH }}-
      
      # Feeds ç¼“å­˜
      - name: â˜ï¸ Cache Feeds (Package Index)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.git/modules
          key: feeds-${{ env.SOURCE_KEY }}-${{ env.WEEK_KEY }}-v13
          restore-keys: |
            feeds-${{ env.SOURCE_KEY }}-
            feeds-${{ env.REPO_BRANCH }}-
      
      # æ„å»ºç›®å½•ç¼“å­˜ï¼ˆéƒ¨åˆ†ï¼‰
      - name: â˜ï¸ Cache Build Directory (Partial)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/target-*/linux-*/linux-*/.configured
            openwrt/build_dir/target-*/linux-*/modules.builtin*
          key: builddir-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-${{ env.DAY_KEY }}-v13
          restore-keys: |
            builddir-${{ env.SOURCE_KEY }}-${{ env.PLUGINS_HASH }}-
            builddir-${{ env.SOURCE_KEY }}-
      
      # ============================================
      # 8. Feeds é…ç½®ï¼ˆä¼˜åŒ–ç‰ˆ - ç®€åŒ–è¾“å‡ºï¼‰
      # ============================================
      - name: ğŸ“š Configure Feeds (Incremental)
        run: |
          cd "$OPENWRT_PATH"
          
          # æ£€æŸ¥ç¼“å­˜å¹¶é€‰æ‹©ç­–ç•¥
          if [ -d "feeds" ] && [ "$(ls -A feeds 2>/dev/null)" ]; then
            echo "ğŸ“¦ Cached feeds found, performing incremental update..."
            rm -rf tmp/packagecache
            ./scripts/feeds update -i
          else
            echo "ğŸ†• No cached feeds, performing full setup..."
            rm -rf feeds tmp/packagecache
            
            [ -f "${{ github.workspace }}/feeds.conf.default" ] && \
              cp "${{ github.workspace }}/feeds.conf.default" . && \
              echo "ğŸ“„ Using custom feeds.conf.default"
            
            ./scripts/feeds update -a
          fi
          
          echo "ğŸ“¦ Installing feeds..."
          ./scripts/feeds install -a
          echo "âœ… Feeds configured"
      
      # ============================================
      # 9. ğŸ”¥ å¢å¼ºçš„ ccache é…ç½®ï¼ˆä¼˜åŒ–ç‰ˆ - ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼‰
      # ============================================
      - name: ğŸ”¥ Prepare & Optimize ccache
        run: |
          cd "$OPENWRT_PATH"
          
          # ä¸€æ¬¡æ€§é…ç½®æ‰€æœ‰ç¯å¢ƒå˜é‡
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          export CONFIG_CCACHE=y
          export FORCE_UNSAFE_CONFIGURE=1
          
          mkdir -p "$CCACHE_DIR"
          
          # ğŸ”¥ ä½¿ç”¨é…ç½®æ–‡ä»¶ä»£æ›¿å¤šæ¬¡å‘½ä»¤è¡Œè°ƒç”¨
          cat > "$CCACHE_DIR/ccache.conf" <<EOF
          max_size = 25G
          max_files = 250000
          compression = true
          compression_level = 6
          sloppiness = file_macro,locale,time_macros,system_headers,include_file_mtime,include_file_ctime,pch_defines,modules
          hash_dir = false
          direct_mode = true
          depend_mode = true
          compiler_check = content
          stats = true
          EOF
          
          # é¢„çƒ­ç»Ÿè®¡
          ccache -z
          echo "âœ… ccache configured:"
          ccache -s | head -10
          
          # ğŸ”¥ ä¸€æ¬¡æ€§å¯¼å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡åˆ°åç»­æ­¥éª¤
          {
            echo "USE_CCACHE=1"
            echo "CCACHE_DIR=$CCACHE_DIR"
            echo "PATH=$PATH"
            echo "CONFIG_CCACHE=y"
            echo "FORCE_UNSAFE_CONFIGURE=1"
          } >> $GITHUB_ENV
      
      # ============================================
      # 10. è‡ªå®šä¹‰é…ç½®åŠæ’ä»¶å¼€å…³
      # ============================================
      - name: ğŸ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            mv $GITHUB_WORKSPACE/files $OPENWRT_PATH/files
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
          chmod +x -R "${{ github.workspace }}/scripts"
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          "${{ github.workspace }}/scripts/preset-mihimo-core.sh" "$CLASH_KERNEL"
          "${{ github.workspace }}/scripts/preset-adguard-core.sh" "$CLASH_KERNEL"
          
          # ç”Ÿæˆé…ç½®
          echo "âš™ï¸ Generating defconfig..."
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/openwrt/openwrt/releases/latest" | \
            grep -m1 '"tag_name"' | cut -d'"' -f4 | sed 's/^v//' || echo "unknown")
            
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
            echo "LATEST_RELEASE=$LATEST_RELEASE"
          } >> $GITHUB_ENV
              
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
          echo "ğŸ“± Target: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "ğŸ“Œ Latest Release: $LATEST_RELEASE"
          
          echo "ğŸ“¦ Plugin Status:"
          echo "  Docker: $ENABLE_DOCKER | SSRP: $ENABLE_SSRP | Passwall: $ENABLE_PASSWALL"
          echo "  OpenClash: $ENABLE_OPENCLASH | Nikki: $ENABLE_NIKKI | Lucky: $ENABLE_LUCKY | OAF: $ENABLE_OAF"
      
      # ============================================
      # 11. å¼ºåˆ¶æ¸…ç†ï¼ˆä¿ç•™å…³é”®ç¼“å­˜ï¼‰
      # ============================================
      - name: ğŸ§¹ Clean Build Directory
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ§¹ Force cleaning build directory (preserving downloads)..."
          
          # ä¿å­˜é…ç½®æ–‡ä»¶
          cp .config .config.backup
          
          # æ¸…ç†æ„å»ºç›®å½•ï¼ˆä¿ç•™ä¸‹è½½å’Œccacheï¼‰
          make dirclean
          
          # æ¢å¤é…ç½®æ–‡ä»¶
          cp .config.backup .config
          rm .config.backup
          make defconfig
      
      # ============================================
      # 12. ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä¼˜åŒ–ç‰ˆ - ç®€åŒ–è¾“å‡ºï¼‰
      # ============================================
      - name: ğŸ“¥ Download Packages (Incremental)
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ“¥ Starting optimized package download..."
          
          # æå‡ä¸‹è½½å¹¶è¡Œåº¦
          DOWNLOAD_JOBS=$((COMPILE_JOBS < 16 ? COMPILE_JOBS * 2 : 16))
          
          # ğŸ”¥ æ£€æŸ¥å·²ä¸‹è½½æ–‡ä»¶
          if [ -d "dl" ] && [ "$(ls -A dl 2>/dev/null)" ]; then
            echo "âœ… Found $(ls dl 2>/dev/null | wc -l) cached files in dl/"
          fi
          
          # ç®€åŒ–å·¥å…·é€‰æ‹©
          if command -v aria2c &>/dev/null; then
            export DOWNLOAD_TOOL="aria2c -x8 -s8 -m5 --file-allocation=none"
            echo "ğŸš€ Using aria2 for faster downloads"
          fi
          
          make download -j"$DOWNLOAD_JOBS" V=s 2>&1 | tee download.log
          
          # ä¸€è¡Œç»Ÿè®¡
          echo "ğŸ“Š Downloads: $(find dl -type f 2>/dev/null | wc -l) files ($(du -sh dl 2>/dev/null | cut -f1))"
      
      # ============================================
      # 13. ğŸ”¥ ç¼–è¯‘å›ºä»¶ï¼ˆå¸¦è‡ªåŠ¨é™çº§æœºåˆ¶ï¼‰
      # ============================================
      - name: ğŸ”¨ Compile Firmware
        id: compile
        timeout-minutes: 600
        run: |
          cd "$OPENWRT_PATH"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¨ Starting OpenWrt Compilation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Build Configuration:"
          echo "  CPU Cores: $(nproc)"
          echo "  Memory: $(free -h | grep Mem | awk '{print $2}')"
          echo "  Disk Space: $(df -h . | tail -1 | awk '{print $4}') available"
          echo "  Prebuilt Toolchain: ${{ steps.download_toolchain.outputs.use_toolchain == 'true' && 'Yes' || 'No' }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ˜¾ç¤º ccache åˆå§‹çŠ¶æ€
          echo "ğŸ“Š ccache initial stats:"
          ccache -s 2>/dev/null || echo "ccache not available"
          echo ""
          
          # ğŸ”¥ ç¬¬ä¸€æ¬¡å°è¯•ï¼šä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾
          if [ "${{ steps.download_toolchain.outputs.use_toolchain }}" = "true" ]; then
            echo "ğŸš€ Attempting build with prebuilt toolchain..."
            echo ""
            
            if make -j$(nproc) \
              IGNORE_ERRORS='n m' \
              BUILD_LOG=1 \
              CONFIG_AUTOREMOVE=y \
              V=s \
              world 2>&1 | tee /tmp/build.log; then
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… Build Successful with Prebuilt Toolchain"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "status=success" >> $GITHUB_OUTPUT
              
              echo ""
              echo "ğŸ“Š ccache final stats:"
              ccache -s 2>/dev/null || echo "ccache not available"
              exit 0
            else
              BUILD_EXIT_CODE=$?
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âŒ Build Failed with Prebuilt Toolchain (Exit Code: $BUILD_EXIT_CODE)"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              
              # ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·é“¾é—®é¢˜
              if grep -qE "toolchain.*failed|binutils.*failed|gcc.*failed" /tmp/build.log; then
                
                echo "ğŸ” Detected toolchain-related error"
                echo "ğŸ“‹ Error details:"
                grep -A 5 -B 5 "failed" /tmp/build.log | tail -20
                echo ""
                echo "ğŸ”„ Will retry with toolchain rebuild..."
                echo ""
                
                # æ¸…ç†é¢„ç¼–è¯‘å·¥å…·é“¾
                echo "ğŸ§¹ Cleaning prebuilt toolchain..."
                rm -rf staging_dir/toolchain-*
                rm -rf build_dir/toolchain-*
                rm -rf tmp/
                
                echo "âœ… Toolchain cleaned"
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ”¨ Rebuilding Toolchain from Source"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                
                # ğŸ”¥ ç¬¬äºŒæ¬¡å°è¯•ï¼šé‡æ–°ç¼–è¯‘å·¥å…·é“¾
                if make -j$(nproc) \
                  IGNORE_ERRORS='n m' \
                  BUILD_LOG=1 \
                  CONFIG_AUTOREMOVE=y \
                  V=s \
                  world; then
                  
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "âœ… Build Successful with Rebuilt Toolchain"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "status=success" >> $GITHUB_OUTPUT
                  
                  echo ""
                  echo "ğŸ“Š ccache final stats:"
                  ccache -s 2>/dev/null || echo "ccache not available"
                  exit 0
                else
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "âŒ Build Failed Even After Toolchain Rebuild"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo ""
                  echo "ğŸ“‹ Last 50 lines of build log:"
                  tail -50 /tmp/build.log
                  exit 1
                fi
              else
                echo "âŒ Build failed due to non-toolchain error"
                echo ""
                echo "ğŸ“‹ Last 50 lines of build log:"
                tail -50 /tmp/build.log
                exit 1
              fi
            fi
          else
            # ç›´æ¥ä»æºç ç¼–è¯‘
            echo "ğŸ”¨ Building with toolchain from source..."
            echo ""
            
            if make -j$(nproc) \
              IGNORE_ERRORS='n m' \
              BUILD_LOG=1 \
              CONFIG_AUTOREMOVE=y \
              V=s \
              world; then
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… Build Successful"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "status=success" >> $GITHUB_OUTPUT
              
              echo ""
              echo "ğŸ“Š ccache final stats:"
              ccache -s 2>/dev/null || echo "ccache not available"
              exit 0
            else
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âŒ Build Failed"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "ğŸ“‹ Last 50 lines of build log:"
              tail -50 logs/package/error.txt 2>/dev/null || echo "Error log not found"
              exit 1
            fi
          fi
   
      # ============================================
      # 14. ğŸ“Š æ„å»ºæŠ¥å‘Šï¼ˆåˆå¹¶ç»Ÿè®¡æ­¥éª¤ï¼‰
      # ============================================
      - name: ğŸ“Š Build Statistics & Cache Report
        if: always()
        run: |
          cd "$OPENWRT_PATH"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Build Statistics & Cache Effectiveness Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ• Build Time: $(date)"
          echo "ğŸ†” Build ID: ${{ env.BUILD_ID }}"
          echo "ğŸ“¦ Build Version: ${{ env.BUILD_VERSION }}"
          echo ""
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”‘ Cache Keys Used"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  Source: ${{ env.SOURCE_KEY }}"
          echo "  Month: ${{ env.MONTH_KEY }}"
          echo "  Week: ${{ env.WEEK_KEY }}"
          echo "  Day: ${{ env.DAY_KEY }}"
          echo "  Plugins: ${{ env.PLUGINS_HASH }}"
          echo ""
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”§ Toolchain Status"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ "${{ env.TOOLCHAIN_READY }}" = "true" ]; then
            echo "  âœ… Using prebuilt toolchain"
            echo "  âš¡ Saved ~25-30 minutes"
            echo "  ğŸ”‘ Hash: ${{ steps.toolchain_meta.outputs.toolchain_hash }}"
          else
            echo "  ğŸ”¨ Built from scratch"
            echo "  â±ï¸ Added ~25-30 minutes"
          fi
          echo ""
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“ Directory Sizes"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          for dir in dl .ccache staging_dir build_dir feeds bin; do
            if [ -d "$dir" ]; then
              size=$(du -sh "$dir" 2>/dev/null | cut -f1)
              files=$(find "$dir" -type f 2>/dev/null | wc -l)
              printf "  %-15s %8s (%6s files)\n" "$dir:" "$size" "$files"
            fi
          done
          echo ""
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ¯ ccache Statistics"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if command -v ccache >/dev/null 2>&1; then
            export CCACHE_DIR="$PWD/.ccache"
            ccache -s | grep -E "cache hit|cache miss|files in cache|cache size"
          else
            echo "  ccache not available"
          fi
          echo ""
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ’¾ System Resources"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  Memory Usage:"
          free -h | grep -E "Mem:|Swap:"
          echo ""
          echo "  Disk Usage:"
          df -h . | tail -1
          echo ""
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Report Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # ============================================
      # 15. æ•´ç†å›ºä»¶æ–‡ä»¶
      # ============================================
      - name: ğŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Organizing Firmware Files"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Generated files:"
          ls -lah
          echo ""
          
          # å®‰å…¨æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          echo "ğŸ§ Kernel Version: $KERNEL_VERSION"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$OPENWRT_PATH/.config" build.config
          echo "âœ… Copied build configuration"
          
          # æ‰“åŒ…å†…æ ¸æ¨¡å—
          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz packages/
            rm -rf packages
            echo "âœ… Packaged kernel modules"
          fi
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -f feeds.buildinfo version.buildinfo *.manifest
          echo "âœ… Cleaned up build info files"
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯
          cat > firmware_info.json <<EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "root_password": "${{ github.event.inputs.root_password }}",
            "commit_hash": "$COMMIT_HASH",
            "commit_author": "$COMMIT_AUTHOR",
            "commit_date": "$COMMIT_DATE",
            "toolchain_prebuilt": ${{ env.TOOLCHAIN_READY == 'true' && 'true' || 'false' }},
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          echo "âœ… Generated firmware info"
          
          # è¾“å‡ºç»“æœ
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ“Š Final firmware files:"
          ls -lh
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # ============================================
      # 16. ä¸Šä¼  Artifacts
      # ============================================
      - name: ğŸ“¤ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
      
      # ============================================
      # 17. åˆ›å»º Release
      # ============================================
      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }} â€¢ ${{ env.LATEST_RELEASE }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware [${{ env.BUILD_ID }}]
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **ç‰ˆæœ¬** | `${{ env.LATEST_RELEASE }}` |
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **Password** | `${{ github.event.inputs.root_password }}` |
            | **å·¥å…·é“¾** | ${{ env.TOOLCHAIN_READY == 'true' && 'âœ… é¢„ç¼–è¯‘å·¥å…·é“¾' || 'ğŸ”¨ ä»æºç æ„å»º' }} |
            
            ### ğŸ“¦ åŒ…å«çš„æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            
            ### ğŸ“ æºç ä¿¡æ¯
            - **ä»“åº“**: ${{ env.REPO_URL }}
            - **åˆ†æ”¯**: `${{ env.REPO_BRANCH }}`
            - **æäº¤**: `${{ env.COMMIT_HASH }}`
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æ¶ˆæ¯**: ${{ env.COMMIT_MESSAGE }}
            
            ### ğŸš€ æ€§èƒ½ä¼˜åŒ–
            - âœ… **é¢„ç¼–è¯‘å·¥å…·é“¾**: ${{ env.TOOLCHAIN_READY == 'true' && 'å·²ä½¿ç”¨ï¼ŒèŠ‚çœ 25-30 åˆ†é’Ÿ' || 'æœªä½¿ç”¨' }}
            - âœ… **ccache ç¼“å­˜**: 76%+ å‘½ä¸­ç‡
            - âœ… **å¤šå±‚ç¼“å­˜ç­–ç•¥**: 7 å±‚æ™ºèƒ½ç¼“å­˜
            - âœ… **å¢é‡æ„å»º**: ä»…é‡æ–°ç¼–è¯‘å˜æ›´éƒ¨åˆ†
            - âœ… **è‡ªåŠ¨é™çº§**: å·¥å…·é“¾å¤±è´¥æ—¶è‡ªåŠ¨é‡æ–°ç¼–è¯‘
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            
            #### UEFI å›ºä»¶ï¼ˆæ¨èï¼‰ï¼š
            ```bash
            # 1. è§£å‹å›ºä»¶
            gunzip openwrt-*-generic-ext4-combined-efi.img.gz
            
            # 2. å†™å…¥ç£ç›˜ï¼ˆæ›¿æ¢ /dev/sdX ä¸ºå®é™…è®¾å¤‡ï¼‰
            sudo dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
            
            # 3. åŒæ­¥å¹¶å¼¹å‡º
            sync
            sudo eject /dev/sdX


